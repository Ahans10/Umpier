<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班系統 | 裁判出勤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">裁判出勤系統</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">您好!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>修改密碼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </button>
            </div>
        </div>

        <!-- 在下方新增一個按鈕列 -->
        <div class="flex justify-center gap-4 mt-10">
            <button id="btn-schedule"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-user-clock text-xl"></i> 排班
            </button>
            <button id="btn-view-registrations"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-clipboard-list text-xl"></i> 報名資訊
            </button>
            <button id="btn-add-match-date"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-calendar-check text-xl"></i> 賽程表管理
            </button>
        </div>

        <div id="content-inner"
            class="mt-8 max-w-3xl mx-auto bg-white/90 border border-blue-300 rounded-2xl shadow p-8 text-blue-900 flex flex-col gap-6">

            <div id="content-area"></div>

            <div class="flex justify-center" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>返回首頁
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                裁判出勤系統
            </small>
        </div>
    </div>
</body>
<script>
    const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

    const profileStr = localStorage.getItem('profile');
    if (profileStr) {
        const profile = JSON.parse(profileStr);
        const roleText = profile.role === 'admin' ? '管理員'
            : profile.role === 'member' ? '裁判員' : '（未知身份）';

        document.getElementById('welcome-title').innerText = `${profile.name || ''} 您好 !`;
        document.getElementById('profile-info').innerHTML = `
            <div>${roleText}</div>
        `;
    }

    const contentArea = document.getElementById('content-area');

    document.getElementById('btn-schedule').addEventListener('click', () => {
        contentArea.innerHTML = `
        <h2 class="text-2xl font-bold mb-6 text-center">班表</h2>
        <p>這裡是排班表內容。</p>
        `;
    });

    document.getElementById('btn-view-registrations').addEventListener('click', async () => {
        contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-center">查看報名狀況</h2>
            <div class="space-y-6">
                <!-- 左右選單 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end" id="query-options">
                    <div>
                        <label class="block font-semibold mb-2">查詢方式：</label>
                        <select id="query-type" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                            <option value="date">依日期查詢</option>
                            <option value="user">依報名者查詢</option>
                        </select>
                    </div>
                    <div id="query-select-box"></div>
                </div>

                <!-- 統一查詢結果區塊（顯示在下方） -->
                <div id="query-result-area" class="text-blue-900"></div>
            </div>
        `;

        const querySelectBox = document.getElementById('query-select-box');
        const queryResultArea = document.getElementById('query-result-area');

        async function loadQuerySection(type) {
            querySelectBox.innerHTML = '';
            queryResultArea.innerHTML = '';

            if (type === 'date') {
                const { data: matchDates, error } = await supabase.from('match_dates').select('id, date').order('date');
                if (error) return queryResultArea.innerHTML = `<p class="text-red-500">載入日期失敗</p>`;

                querySelectBox.innerHTML = `
                        <label class="block font-semibold mb-2">選擇比賽日期：</label>
                        <select id="date-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                            <option value="">請選擇</option>
                            ${matchDates.map(d => {
                    const dstr = new Date(d.date).toLocaleDateString('zh-TW', {
                        year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                    });
                    return `<option value="${d.id}">${dstr}</option>`;
                }).join('')}
                        </select>
                    `;

                document.getElementById('date-select').addEventListener('change', async function () {
                    const dateId = this.value;
                    queryResultArea.innerHTML = '';
                    if (!dateId) return;

                    const { data, error } = await supabase
                        .from('registrations')
                        .select('description, user_id, match_date_id, profiles(name)')
                        .eq('match_date_id', dateId);

                    if (error) {
                        queryResultArea.innerHTML = `<p class="text-red-500 font-medium">查詢失敗，請稍後再試。</p>`;
                    } else if (data.length === 0) {
                        queryResultArea.innerHTML = `<p class="text-gray-500 font-medium">目前尚無人報名此日期。</p>`;
                    } else {
                        queryResultArea.innerHTML = `
                                <table class="w-full border border-blue-300 text-sm text-left mt-4">
                                    <thead class="bg-blue-100 text-blue-800">
                                        <tr>
                                            <th class="border px-4 py-2 w-32">姓名</th>
                                            <th class="border px-4 py-2">備註</th>
                                            <th class="border px-4 py-2 w-20">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        ${data.map((r, i) => `
                                            <tr>
                                                <td class="border px-4 py-2">${r.profiles.name}</td>
                                                <td class="border px-4 py-2">${r.description || '無'}</td>
                                                <td class="border px-4 py-2">
                                                    <div class="flex justify-center items-center gap-3">
                                                        <button onclick="editRemarkByRow(${i})"
                                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
                                                            title="修改備註">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deleteRegistrationByRow(${i})"
                                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition"
                                                            title="刪除報名">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        window.latestDateRegData = data;
                    }
                });

            } else if (type === 'user') {
                const { data: users, error } = await supabase.from('profiles').select('id, name').order('name');
                if (error) return queryResultArea.innerHTML = `<p class="text-red-500">載入使用者失敗</p>`;

                querySelectBox.innerHTML = `
                        <label class="block font-semibold mb-2">選擇報名者：</label>
                        <select id="user-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                            <option value="">請選擇</option>
                            ${users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                        </select>
                    `;

                document.getElementById('user-select').addEventListener('change', async function () {
                    const userId = this.value;
                    queryResultArea.innerHTML = '';
                    if (!userId) return;

                    const { data, error } = await supabase
                        .from('registrations')
                        .select('description, match_dates(id, date), user_id, match_date_id')
                        .eq('user_id', userId);

                    if (!error && data) {
                        data.sort((a, b) => new Date(a.match_dates.date) - new Date(b.match_dates.date));
                    }

                    if (error) {
                        queryResultArea.innerHTML = `<p class="text-red-500 font-medium">查詢失敗，請稍後再試。</p>`;
                    } else {
                        if (data.length === 0) {
                            queryResultArea.innerHTML = `<p class="text-gray-500 font-medium">尚未報名任何場次。</p>`;
                        } else {
                            queryResultArea.innerHTML = `
                                    <table class="w-full border border-blue-300 text-sm text-left mt-4">
                                        <thead class="bg-blue-100 text-blue-800">
                                            <tr>
                                                <th class="border px-4 py-2 w-44">日期</th>
                                                <th class="border px-4 py-2">備註</th>
                                                <th class="border px-4 py-2 w-20">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white">
                                            ${data.map((r, i) => `
                                                <tr>
                                                    <td class="border px-4 py-2">${new Date(r.match_dates.date).toLocaleDateString('zh-TW', {
                                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                            })}</td>
                                                    <td class="border px-4 py-2">${r.description || '無'}</td>
                                                    <td class="border px-4 py-2">
                                                        <div class="flex justify-center items-center gap-3">
                                                            <button onclick="editRemark(${i})"
                                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
                                                                title="修改備註">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="deleteRegistration(${i})"
                                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition"
                                                                title="刪除報名">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `;
                            window.latestUserRegData = data;
                        }

                        const { data: allDates, error: dateErr } = await supabase.from('match_dates').select('id, date').order('date');
                        if (dateErr) return queryResultArea.innerHTML += `<p class="text-red-500 mt-4">載入可新增場次失敗</p>`;

                        const registeredIds = data.map(r => r.match_date_id);
                        const availableDates = allDates.filter(d => !registeredIds.includes(d.id)).sort((a, b) => new Date(a.date) - new Date(b.date));

                        if (availableDates.length === 0) {
                            queryResultArea.innerHTML += `<p class="text-gray-500 mt-6 font-medium">此使用者已報名所有場次。</p>`;
                        } else {
                            queryResultArea.innerHTML += `
                                    <div class="mt-10 pt-6 border-t border-blue-200">
                                        <h3 class="text-lg font-bold mb-4">為該使用者新增報名場次</h3>
                                        <form id="admin-add-form" class="space-y-4">
                                            ${availableDates.map(d => {
                                const dateStr = new Date(d.date).toLocaleDateString('zh-TW', {
                                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                                });
                                return `
                                                    <div class="flex items-center gap-4">
                                                        <input type="checkbox" id="chk-${d.id}" name="dates" value="${d.id}" class="w-5 h-5 text-blue-600" />
                                                        <label for="chk-${d.id}" class="w-48 font-medium">${dateStr}</label>
                                                        <input type="text" name="note-${d.id}" placeholder="備註（可不填）"
                                                            class="flex-1 px-3 py-1.5 border rounded bg-white text-blue-900" />
                                                    </div>`;
                            }).join('')}
                                            <div class="text-right">
                                                <button type="submit"
                                                    class="mt-4 px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                                    送出新增
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                `;

                            document.getElementById('admin-add-form').addEventListener('submit', async function (e) {
                                e.preventDefault();

                                const checked = Array.from(document.querySelectorAll('input[name="dates"]:checked'));
                                if (checked.length === 0) return alert('請勾選至少一個比賽日期');

                                const insertData = checked.map(cb => {
                                    const id = cb.value;
                                    const note = document.querySelector(`input[name="note-${id}"]`)?.value.trim() || '';
                                    return {
                                        user_id: userId,
                                        match_date_id: id,
                                        description: note,
                                        registred_at: new Date().toISOString()
                                    };
                                });

                                const { error: insertErr } = await supabase.from('registrations').insert(insertData);
                                if (insertErr) {
                                    alert('新增失敗，請稍後再試');
                                    console.error(insertErr);
                                } else {
                                    alert('新增成功');
                                    document.getElementById('user-select').dispatchEvent(new Event('change')); // 重新載入
                                }
                            });
                        }
                    }
                });
            }
        }

        await loadQuerySection('date');

        document.getElementById('query-type').addEventListener('change', function () {
            loadQuerySection(this.value);
        });
        
    });
        async function editRemarkByRow(index) {
            const row = window.latestDateRegData[index];
            const oldRemark = row.description || '';
            const newRemark = prompt('請輸入新的備註：', oldRemark);
            if (newRemark === null) return;

            const { error } = await supabase
                .from('registrations')
                .update({ description: newRemark })
                .match({
                    user_id: row.user_id,
                    match_date_id: row.match_date_id
                });

            if (error) {
                alert('更新失敗，請稍後再試');
            } else {
                alert('更新成功');
                document.getElementById('date-select').dispatchEvent(new Event('change'));
            }
        }
        async function deleteRegistrationByRow(index) {
            const row = window.latestDateRegData[index];
            const confirmDelete = confirm(`確定要刪除 ${row.profiles.name} 的報名紀錄嗎？`);
            if (!confirmDelete) return;

            const { error } = await supabase
                .from('registrations')
                .delete()
                .match({
                    user_id: row.user_id,
                    match_date_id: row.match_date_id
                });

            if (error) {
                alert('刪除失敗，請稍後再試');
            } else {
                alert('刪除成功');
                document.getElementById('date-select').dispatchEvent(new Event('change'));
            }
        }
        async function editRemark(index) {
            const row = window.latestUserRegData[index];
            const oldRemark = row.description || '';
            const newRemark = prompt('請輸入新的備註：', oldRemark);
            if (newRemark === null) return;
            console.log('Updating...', {
                user_id: row.user_id,
                match_date_id: row.match_date_id,
                description: newRemark
            });

            const { error } = await supabase
                .from('registrations')
                .update({ description: newRemark })
                .match({
                    user_id: row.user_id,
                    match_date_id: row.match_date_id
                });

            if (error) {
                alert('更新失敗，請稍後再試');
            } else {
                alert('更新成功');
                document.getElementById('user-select').dispatchEvent(new Event('change')); // 重新載入
            }
        }
        async function deleteRegistration(index) {
            const row = window.latestUserRegData[index];
            const confirmDelete = confirm(`確定要刪除報名日期：${new Date(row.match_dates.date).toLocaleDateString('zh-TW')} 的紀錄嗎？`);
            if (!confirmDelete) return;

            const { error } = await supabase
                .from('registrations')
                .delete()
                .match({
                    user_id: row.user_id,
                    match_date_id: row.match_date_id
                });

            if (error) {
                alert('刪除失敗，請稍後再試');
            } else {
                alert('刪除成功');
                document.getElementById('user-select').dispatchEvent(new Event('change')); // 重新載入資料
            }
        }

    document.getElementById('btn-add-match-date').addEventListener('click', async () => {
        contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-center">新增賽程</h2>

            <form id="match-form" class="space-y-6">
            <!-- 賽事 -->
            <div>
                <label class="block font-semibold mb-2">賽事名稱</label>
                <select id="games-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                <option value="">載入中...</option>
                </select>
            </div>

            <!-- 日期、地點 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                <label class="block font-semibold mb-2">日期</label>
                <select id="date-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                </select>
                </div>
                <div>
                <label class="block font-semibold mb-2">地點</label>
                <select id="loc-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                </select>
                </div>
            </div>

            <!-- 編號、時間 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                <label class="block font-semibold mb-2">編號（場次）</label>
                <input id="session-input" type="text" placeholder="例：A1 或 1"
                        class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
                </div>
                <div>
                <label class="block font-semibold mb-2">時間</label>
                <input id="time-input" type="time"
                        class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
                </div>
            </div>

            <!-- 先攻 / 後攻 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                <label class="block font-semibold mb-2">先攻隊伍</label>
                <select id="team1-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">請先選擇賽事</option>
                </select>
                </div>
                <div>
                <label class="block font-semibold mb-2">後攻隊伍</label>
                <select id="team2-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">請先選擇賽事</option>
                </select>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                新增賽程
                </button>
            </div>
            </form>

            <!-- 搜尋區塊 -->
            <div class="mt-10 pt-6 border-t border-blue-200">
            <h3 class="text-xl font-bold mb-4">查詢賽程</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                <div>
                <label class="block font-semibold mb-2">賽事</label>
                <select id="q-game" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                </select>
                </div>
                <div>
                <label class="block font-semibold mb-2">地點</label>
                <select id="q-loc" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                </select>
                </div>
                <div class="flex sm:block">
                <button id="btn-query" class="w-full px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">查詢</button>
                </div>
            </div>
            <div id="search-tip" class="text-sm text-blue-700 mt-2"></div>
            <div id="search-result" class="mt-6 space-y-8"></div>
            </div>

            <div id="match-tip" class="text-sm text-blue-700 mt-2"></div>
        `;

        const el = {
            form: document.getElementById('match-form'),
            games: document.getElementById('games-select'),
            date: document.getElementById('date-select'),
            loc: document.getElementById('loc-select'),
            session: document.getElementById('session-input'),
            time: document.getElementById('time-input'),
            team1: document.getElementById('team1-select'),
            team2: document.getElementById('team2-select'),
            tip: document.getElementById('match-tip'),
            // 搜尋
            qGame: document.getElementById('q-game'),
            qLoc: document.getElementById('q-loc'),
            btnQuery: document.getElementById('btn-query'),
            searchTip: document.getElementById('search-tip'),
            searchResult: document.getElementById('search-result'),
        };

        const maps = {
            games: new Map(),
            dates: new Map(),
            datesLabel: new Map(),
            locs: new Map(),
            teams: new Map(),
            profiles: new Map(),
        };

        let currentEditId = null;

        function exitEditMode() {
            currentEditId = null;
            el.form.reset();
            el.games.dispatchEvent(new Event('change'));
            const submitBtn = el.form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.textContent = '新增賽程';
            const cancelBtn = document.getElementById('btn-cancel-edit');
            if (cancelBtn) cancelBtn.remove();
        }

        async function fillFormFromMatch(row) {
            el.games.value = row.games_id || '';
            await loadTeamsByGame(el.games.value);

            el.date.value = row.match_dates_id || '';
            el.loc.value = row.locations_id || '';
            el.session.value = row.session || '';
            el.time.value = (row.time || '').slice(0, 5);
            el.team1.value = row.teams_id1 || '';
            el.team2.value = row.teams_id2 || '';

            const submitBtn = el.form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.textContent = '儲存修改';

            if (!document.getElementById('btn-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'btn-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 border rounded hover:bg-blue-50';
                cancelBtn.textContent = '取消修改';
                submitBtn.parentElement.prepend(cancelBtn);
                cancelBtn.addEventListener('click', exitEditMode);
            }
        }

        async function loadStaticOptions() {
            el.tip.textContent = '載入選單中...';

            const [gamesRes, datesRes, locsRes] = await Promise.all([
                supabase.from('games').select('id, name').order('name', { ascending: true }),
                supabase.from('match_dates').select('id, date').order('date', { ascending: true }),
                supabase.from('locations').select('id, name').order('name', { ascending: true })
            ]);

            if (gamesRes.error) {
                el.games.innerHTML = `<option value="">載入賽事失敗</option>`;
                el.qGame.innerHTML = `<option value="">載入賽事失敗</option>`;
                console.error(gamesRes.error);
            } else {
                const opts = (gamesRes.data || []);
                el.games.innerHTML = `<option value="">請選擇賽事</option>` +
                    opts.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                el.qGame.innerHTML = `<option value="">請選擇賽事</option>` +
                    opts.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                maps.games.clear();
                opts.forEach(g => maps.games.set(String(g.id), g.name));
            }

            if (datesRes.error) {
                el.date.innerHTML = `<option value="">載入日期失敗</option>`;
                console.error(datesRes.error);
            } else {
                const opts = (datesRes.data || []);
                el.date.innerHTML = `<option value="">請選擇日期</option>` +
                    opts.map(d => {
                        const iso = String(d.date).slice(0, 10);
                        const label = new Date(d.date).toLocaleDateString('zh-TW', {
                            year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short'
                        });
                        maps.dates.set(String(d.id), iso);
                        maps.datesLabel.set(String(d.id), label);
                        return `<option value="${d.id}">${label}</option>`;
                    }).join('');
            }

            if (locsRes.error) {
                el.loc.innerHTML = `<option value="">載入地點失敗</option>`;
                el.qLoc.innerHTML = `<option value="">載入地點失敗</option>`;
                console.error(locsRes.error);
            } else {
                const opts = (locsRes.data || []);
                el.loc.innerHTML = `<option value="">請選擇地點</option>` +
                    opts.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                el.qLoc.innerHTML = `<option value="">請選擇地點</option>` +
                    opts.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                maps.locs.clear();
                opts.forEach(l => maps.locs.set(String(l.id), l.name));
            }

            el.tip.textContent = '';
        }

        async function loadTeamsByGame(gameId) {
            if (!gameId) {
                el.team1.innerHTML = `<option value="">請先選擇賽事</option>`;
                el.team2.innerHTML = `<option value="">請先選擇賽事</option>`;
                return;
            }
            const { data, error } = await supabase
                .from('teams')
                .select('id, name')
                .eq('games_id', gameId)
                .order('name', { ascending: true });

            if (error) {
                console.error(error);
                el.team1.innerHTML = `<option value="">載入隊伍失敗</option>`;
                el.team2.innerHTML = `<option value="">載入隊伍失敗</option>`;
                return;
            }

            const options = `<option value="">請選擇隊伍</option>` +
                (data || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            el.team1.innerHTML = options;
            el.team2.innerHTML = options;

            maps.teams.clear();
            (data || []).forEach(t => maps.teams.set(String(t.id), t.name));
        }

        el.games.addEventListener('change', () => loadTeamsByGame(el.games.value));

        el.form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                games_id: el.games.value || null,
                match_dates_id: el.date.value || null,
                locations_id: el.loc.value || null,
                session: (el.session.value || '').trim(),
                time: el.time.value || null,
                teams_id1: el.team1.value || null,
                teams_id2: el.team2.value || null,
                home_id: null, base1_id: null, base2_id: null, base3_id: null,
                recorder_id: null, supervisor_id: null,
                remark: null,
                upload: false
            };

            if (!payload.games_id) return alert('請選擇賽事');
            if (!payload.match_dates_id) return alert('請選擇日期');
            if (!payload.locations_id) return alert('請選擇地點');
            if (!payload.session) return alert('請輸入場次編號');
            if (!payload.time) return alert('請選擇時間');
            if (!payload.teams_id1 || !payload.teams_id2) return alert('請選擇先攻與後攻隊伍');
            if (payload.teams_id1 === payload.teams_id2) return alert('先攻與後攻隊伍不可相同');

            const { data: chkTeams, error: chkErr } = await supabase
                .from('teams')
                .select('id, games_id')
                .in('id', [payload.teams_id1, payload.teams_id2]);

            if (chkErr) { console.error(chkErr); return alert('驗證隊伍所屬賽事失敗，請稍後再試'); }
            const ok = Array.isArray(chkTeams) && chkTeams.length === 2 &&
                chkTeams.every(t => String(t.games_id) === String(payload.games_id));
            if (!ok) return alert('所選隊伍不屬於同一賽事，請重新選擇');

            if (currentEditId) {
                const { error: updErr } = await supabase
                    .from('matches')
                    .update(payload)
                    .eq('id', currentEditId);

                if (updErr) {
                    console.error(updErr);
                    alert('更新失敗，請稍後再試');
                } else {
                    alert('更新成功！');
                    exitEditMode();
                    if (el.qGame.value && el.qLoc.value) el.btnQuery.click();
                }
            } else {
                const { error: insErr } = await supabase.from('matches').insert(payload);
                if (insErr) {
                    console.error(insErr);
                    alert('新增賽程失敗，請稍後再試');
                } else {
                    alert('賽程新增成功！');
                    el.date.value = ''; el.loc.value = ''; el.session.value = '';
                    el.time.value = ''; el.team1.value = ''; el.team2.value = '';
                }
            }
        });

        el.btnQuery.addEventListener('click', async () => {
            const gameId = el.qGame.value;
            const locId = el.qLoc.value;

            if (!gameId) return alert('請選擇要查詢的賽事');
            if (!locId) return alert('請選擇要查詢的地點');

            el.searchTip.textContent = '查詢中...';
            el.searchResult.innerHTML = '';

            const { data: rows, error } = await supabase
                .from('matches')
                .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2')
                .eq('games_id', gameId)
                .eq('locations_id', locId);

            if (error) {
                console.error(error);
                el.searchTip.textContent = '查詢失敗，請稍後再試';
                return;
            }

            if (!rows || rows.length === 0) {
                el.searchTip.textContent = '沒有資料。';
                return;
            }

            const teamIds = new Set();
            rows.forEach(r => {
                if (r.teams_id1) teamIds.add(r.teams_id1);
                if (r.teams_id2) teamIds.add(r.teams_id2);
            });
            if (teamIds.size > 0) {
                const { data: teamList, error: teamErr } = await supabase
                    .from('teams')
                    .select('id, name')
                    .in('id', Array.from(teamIds));
                if (!teamErr && teamList) {
                    teamList.forEach(t => maps.teams.set(String(t.id), t.name));
                }
            }

            const byDate = {};
            rows.forEach(r => {
                const iso = maps.dates.get(String(r.match_dates_id)) || '未知日期';
                if (!byDate[iso]) byDate[iso] = [];
                byDate[iso].push(r);
            });

            const dateKeys = Object.keys(byDate).sort();

            dateKeys.forEach(d => {
                byDate[d].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            });

            const gameName = maps.games.get(String(gameId)) || '';
            const locName = maps.locs.get(String(locId)) || '';

            el.searchResult.innerHTML = dateKeys.map(d => {
                const dLabel = [...maps.datesLabel.entries()]
                    .find(([id, lbl]) => maps.dates.get(id) === d)?.[1] || d;

                const rowsHtml = byDate[d].map(r => {
                    const t1 = maps.teams.get(String(r.teams_id1)) || r.teams_id1 || '-';
                    const t2 = maps.teams.get(String(r.teams_id2)) || r.teams_id2 || '-';
                    const time = r.time || '-';
                    const session = r.session || '-';
                    const confirmText = `確定刪除：
                        日期：${dLabel}
                        賽事：${gameName}
                        地點：${locName}
                        時間：${time}
                        場次：${session}
                        對戰：${t1} vs ${t2}
                        此操作無法復原。`;

                    return `
                        <tr data-id="${r.id}">
                            <td class="border px-3 py-2 text-center">${session}</td>
                            <td class="border px-3 py-2 text-center whitespace-nowrap">${time}</td>
                            <td class="border px-3 py-2 text-center">${t1}</td>
                            <td class="border px-3 py-2 text-center">vs</td>
                            <td class="border px-3 py-2 text-center">${t2}</td>
                            <td class="border px-3 py-2 text-center">
                                <button
                                class="btn-edit-match inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"
                                title="修改"
                                data-id="${r.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button
                                class="btn-del-match inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200"
                                title="刪除"
                                data-id="${r.id}"
                                data-confirm="${confirmText.replace(/"/g, '&quot;')}"
                            >
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            </td>
                        </tr>
                        `;
            }).join('');

                return `
                    <div class="rounded-xl border border-blue-300 overflow-hidden">
                    <div class="bg-blue-50 px-4 py-3 font-semibold">
                        ${dLabel} ｜ ${gameName} ｜ 地點：${locName}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm bg-white text-center"> <!-- 整張表置中 -->
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                            <th class="border px-3 py-2 text-center">場次</th>
                            <th class="border px-3 py-2 text-center">時間</th>
                            <th class="border px-3 py-2 text-center">先攻</th>
                            <th class="border px-3 py-2 text-center">VS</th>
                            <th class="border px-3 py-2 text-center">後攻</th>
                            <th class="border px-3 py-2 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHtml}
                        </tbody>
                        </table>
                    </div>
                    </div>
                `;
            }).join('');

            el.searchResult.querySelectorAll('.btn-del-match').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const msg = btn.getAttribute('data-confirm') || '確定刪除？此操作無法復原。';
                    if (!confirm(msg)) return;

                    const { error: delErr } = await supabase.from('matches').delete().eq('id', id);
                    if (delErr) {
                        console.error(delErr);
                        alert('刪除失敗，請稍後再試');
                    } else {
                        el.btnQuery.click();
                    }
                });
            });

            el.searchResult.querySelectorAll('.btn-edit-match').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const { data, error } = await supabase
                        .from('matches')
                        .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2')
                        .eq('id', id)
                        .single();

                    if (error || !data) {
                        console.error(error);
                        alert('讀取資料失敗，請稍後再試');
                        return;
                    }

                    currentEditId = id;
                    await fillFormFromMatch(data);
                    el.form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            el.searchTip.textContent = `共 ${rows.length} 場比賽。`;
        });

        await loadStaticOptions();
    });

    document.getElementById('logout-btn').addEventListener('click', function () {
        localStorage.removeItem('profile');
        window.location.href = 'index.html';
    });

    document.getElementById('btn-schedule').click();
</script>

</html>