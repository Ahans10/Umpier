<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班系統 | 裁判出勤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">裁判出勤系統</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">您好!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>修改密碼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </button>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-10">
            <button id="btn-schedule"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-user-clock text-xl"></i> 排班
            </button>
            <button id="btn-view-registrations"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-clipboard-list text-xl"></i> 報名資訊
            </button>
            <button id="btn-add-match-date"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-calendar-check text-xl"></i> 賽程表管理
            </button>
        </div>

        <div id="content-inner"
            class="mt-8 max-w-7xl mx-auto bg-white/90 border border-blue-300 rounded-2xl shadow p-8 text-blue-900 flex flex-col gap-6">

            <div id="content-area"></div>

            <div class="flex justify-center" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>返回首頁
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                裁判出勤系統
            </small>
        </div>
    </div>
</body>
<script>
    const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

    const profileStr = localStorage.getItem('profile');
    if (profileStr) {
        const profile = JSON.parse(profileStr);
        const roleText = profile.role === 'admin' ? '管理員'
            : profile.role === 'member' ? '裁判員' : '（未知身份）';

        document.getElementById('welcome-title').innerText = `${profile.name || ''} 您好 !`;
        document.getElementById('profile-info').innerHTML = `
            <div>${roleText}</div>
        `;
    }

    (function ensureToast() {
        if (document.getElementById('app-toast-root')) return;
        const root = document.createElement('div');
        root.id = 'app-toast-root';
        root.className = 'fixed top-4 right-4 z-[9999] space-y-2';
        document.body.appendChild(root);
    })();
    function showToast(message, type = 'info') {
        const root = document.getElementById('app-toast-root');
        const color = type === 'success' ? 'bg-green-600'
            : type === 'error' ? 'bg-red-600'
                : type === 'warn' ? 'bg-yellow-600'
                    : 'bg-blue-600';
        const box = document.createElement('div');
        box.className = `${color} text-white shadow-lg rounded-lg px-4 py-3 flex items-start gap-3 opacity-0 transition-opacity`;
        box.innerHTML = `
            <span class="mt-0.5"><i class="fa-solid ${type === 'success' ? 'fa-circle-check' : type === 'error' ? 'fa-triangle-exclamation' : type === 'warn' ? 'fa-circle-exclamation' : 'fa-circle-info'}"></i></span>
            <div class="font-medium">${message}</div>
            <button class="ml-3 text-white/80 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        `;
        const closeBtn = box.querySelector('button');
        closeBtn.addEventListener('click', () => root.removeChild(box));
        root.appendChild(box);
        requestAnimationFrame(() => box.classList.remove('opacity-0'));
        setTimeout(() => {
            if (root.contains(box)) root.removeChild(box);
        }, 3000);
    }

    const contentArea = document.getElementById('content-area');

    document.getElementById('btn-schedule').addEventListener('click', async () => {
        contentArea.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">排班</h2>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end mb-6">
                <div>
                    <label class="block font-semibold mb-2">日期</label>
                    <select id="sch-date" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">地點</label>
                    <select id="sch-loc" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                    </select>
                </div>
                <div>
                    <button id="btn-sch-query" class="w-full px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    查詢
                    </button>
                </div>
                </div>

                <div id="sch-tip" class="text-sm text-blue-700 mb-2"></div>
                <div id="sch-result" class="space-y-10"></div>
            `;

        const el = {
            date: document.getElementById('sch-date'),
            loc: document.getElementById('sch-loc'),
            btn: document.getElementById('btn-sch-query'),
            tip: document.getElementById('sch-tip'),
            result: document.getElementById('sch-result'),
        };

        const GUEST_PREFIX = 'guest:';
        const GUEST_ADD_VALUE = `${GUEST_PREFIX}add`;
        const guestPickMap = new Map();
        const uuid4 = () => URL.createObjectURL(new Blob()).slice(-36);
        const maps = {
            games: new Map(),
            locs: new Map(),
            dates: new Map(),
            datesLabel: new Map(),
            teams: new Map(),
        };
        const getNote = (p) => (p?.note ?? p?.remark ?? '');

        function attachNotePreview(selectEl) {
            const holder = document.createElement('div');
            holder.className = 'text-xs text-slate-600 mt-1 h-4';
            const update = () => {
                const opt = selectEl.options[selectEl.selectedIndex];
                const note = opt ? (opt.getAttribute('data-note') || '') : '';
                holder.textContent = note ? `備註：${note}` : '';
            };
            selectEl.addEventListener('change', update);
            update();
            selectEl.parentElement.appendChild(holder);
        }

        function makePersonOptions(people, selectedId, withGuestAdd = true) {
            const opts = ['<option value=""></option>'];
            people.forEach(p => {
                const sel = String(p.id) === String(selectedId) ? 'selected' : '';
                const safeNote = (getNote(p) || '').replace(/"/g, '&quot;');
                opts.push(
                    `<option value="${p.id}" ${sel} title="${p.name}${safeNote ? '：' + safeNote : ''}" data-note="${safeNote}">${p.name}</option>`
                );
            });
            if (withGuestAdd) {
                opts.push(`<option value="${GUEST_ADD_VALUE}" data-note="">＋加入臨時人員…</option>`);
            }
            return opts.join('');
        }

        async function loadStaticOptions() {
            el.tip.textContent = '載入選項中...';

            const [locsRes, datesRes, gamesRes] = await Promise.all([
                supabase.from('locations').select('id, name').order('name'),
                supabase.from('match_dates').select('id, date').order('date'),
                supabase.from('games').select('id, name').order('name'),
            ]);

            if (!locsRes.error) {
                const ls = locsRes.data || [];
                el.loc.innerHTML = `<option value="">請選擇地點</option>` +
                    ls.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                maps.locs.clear(); ls.forEach(l => maps.locs.set(String(l.id), l.name));
            } else {
                el.loc.innerHTML = `<option value="">載入地點失敗</option>`;
            }

            if (!datesRes.error) {
                const ds = datesRes.data || [];
                el.date.innerHTML = `<option value="">請選擇日期</option>` +
                    ds.map(d => {
                        const iso = String(d.date).slice(0, 10);
                        const id = String(d.id);
                        maps.dates.set(id, iso);
                        const label = new Date(d.date).toLocaleDateString('zh-TW', {
                            year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short'
                        });
                        maps.datesLabel.set(id, label);
                        return `<option value="${id}">${label}</option>`;
                    }).join('');
            } else {
                el.date.innerHTML = `<option value="">載入日期失敗</option>`;
            }

            if (!gamesRes.error) { (gamesRes.data || []).forEach(g => maps.games.set(String(g.id), g.name)); }
            el.tip.textContent = '';
        }
        await loadStaticOptions();

        el.date.addEventListener('change', () => {
            const did = el.date.value;
            const lid = el.loc.value;
            if (did && !lid) {
                runQuery({ dateId: did, locId: null });
            } else {
                el.result.innerHTML = '';
                el.tip.textContent = did || lid ? '可按查詢顯示結果' : '';
            }
        });
        el.btn.addEventListener('click', () => {
            const did = el.date.value || null;
            const lid = el.loc.value || null;
            if (!did && !lid) return alert('請先選擇「日期」或「地點」（或兩者）');
            runQuery({ dateId: did, locId: lid });
        });

        async function runQuery({ dateId, locId }) {
            el.result.innerHTML = '';
            el.tip.textContent = '查詢中...';

            let q = supabase
                .from('matches')
                .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2, home_id, base1_id, base2_id, base3_id, recorder_id, supervisor_id, remark, upload');

            if (dateId) q = q.eq('match_dates_id', dateId);
            if (locId) q = q.eq('locations_id', locId);

            const { data: rows, error } = await q;
            if (error) { console.error(error); el.tip.textContent = '查詢失敗，請稍後再試'; return; }
            if (!rows || rows.length === 0) { el.tip.textContent = '沒有資料。'; return; }

            const teamIds = new Set(), dateIds = new Set(), locIds = new Set();
            rows.forEach(r => {
                if (r.teams_id1) teamIds.add(r.teams_id1);
                if (r.teams_id2) teamIds.add(r.teams_id2);
                if (r.match_dates_id) dateIds.add(r.match_dates_id);
                if (r.locations_id) locIds.add(r.locations_id);
            });

            if (teamIds.size) {
                const { data: tlist } = await supabase.from('teams').select('id,name').in('id', Array.from(teamIds));
                (tlist || []).forEach(t => maps.teams.set(String(t.id), t.name));
            }

            const { data: regs } = await supabase
                .from('registrations')
                .select('user_id, match_date_id, description')
                .in('match_date_id', Array.from(dateIds));

            const peopleByDate = {};
            const regUserIds = Array.from(new Set((regs || []).map(r => r.user_id)));
            if (regUserIds.length) {
                const { data: profs } = await supabase.from('profiles').select('id, name').in('id', regUserIds);
                (profs || []).forEach(p => {
                    const uid = String(p.id);
                    (regs || []).forEach(r => {
                        if (String(r.user_id) !== uid) return;
                        const did = String(r.match_date_id);
                        if (!peopleByDate[did]) peopleByDate[did] = [];
                        const exist = peopleByDate[did].find(x => x.id === uid);
                        const regNote = (r.description || '').trim();
                        if (!exist) peopleByDate[did].push({ id: uid, name: p.name, note: regNote });
                        else {
                            const setNotes = new Set([exist.note, regNote].filter(Boolean));
                            exist.note = Array.from(setNotes).join(' / ');
                        }
                    });
                });
            }

            async function upsertGuestAssignment({ matchId, role, guestName, guestNote }) {
                matchId = String(matchId || '').trim();
                role = String(role || '').trim();

                if (!matchId || !role) throw new Error('missing matchId or role');

                if (!guestName || !guestName.trim()) {
                    await supabase
                        .from('match_guest_assignments')
                        .delete()
                        .eq('match_id', matchId)
                        .eq('role', role);
                    return { deleted: true };
                }

                await supabase
                    .from('match_guest_assignments')
                    .delete()
                    .eq('match_id', matchId)
                    .eq('role', role);

                const { error } = await supabase
                    .from('match_guest_assignments')
                    .insert([{
                        match_id: matchId,
                        role,
                        guest_name: guestName.trim(),
                        guest_note: guestNote ? String(guestNote).trim() : null,
                    }]);

                if (error) throw error;
                return { inserted: true };
            }

            const { data: supervisors } = await supabase.from('supervisor').select('id, name').order('name', { ascending: true });

            const BUFFER_MIN = 180;
            const { data: otherLocMatches, error: otherErr } = await supabase
                .from('matches')
                .select('id, match_dates_id, locations_id, time, home_id, base1_id, base2_id, base3_id, recorder_id')
                .in('match_dates_id', dateIds);
            if (otherErr) console.error('cross-venue 查詢失敗', otherErr);

            const conflictIndex = new Map();
            const hhmmToMin = (hhmm) => { const [h, m] = (hhmm || '').slice(0, 5).split(':').map(Number); return Number.isFinite(h) && Number.isFinite(m) ? h * 60 + m : null; };
            (otherLocMatches || []).forEach(m => {
                const tmin = hhmmToMin(m.time); if (tmin == null) return;
                const did = String(m.match_dates_id);
                if (!conflictIndex.has(did)) conflictIndex.set(did, new Map());
                const mp = conflictIndex.get(did);
                ['home_id', 'base1_id', 'base2_id', 'base3_id', 'recorder_id'].forEach(k => {
                    const pid = m[k]; if (!pid) return;
                    const key = String(pid);
                    const arr = mp.get(key) || [];
                    arr.push({ t: tmin, locId: m.locations_id });
                    mp.set(key, arr);
                });
            });

            function hasCrossVenueConflict(dateId, profileId, hhmm, currentLocId) {
                if (!profileId || String(profileId).startsWith(GUEST_PREFIX)) return false;
                const tSelf = hhmmToMin(hhmm); if (tSelf == null) return false;
                const mp = conflictIndex.get(String(dateId)); if (!mp) return false;
                const arr = mp.get(String(profileId)); if (!arr) return false;
                const curLoc = String(currentLocId);
                return arr.some(({ t, locId }) => String(locId) !== curLoc && Math.abs(t - tSelf) < BUFFER_MIN);
            }

            const matchIds = rows.map(r => r.id);
            let guestByKey = new Map();

            if (matchIds.length) {
                const { data: guestAssigned, error: guestErr } = await supabase
                    .from('match_guest_assignments')
                    .select('id, match_id, role, guest_name, guest_note')
                    .in('match_id', matchIds);

                if (!guestErr && guestAssigned) {
                    guestAssigned.forEach(g => {
                        const key = `${String(g.match_id)}:${g.role}`;
                        guestByKey.set(key, g);
                    });
                } else {
                    console.warn('載入臨時人員失敗：', guestErr);
                }
            }

            const groups = new Map();
            rows.forEach(r => {
                const key = `${r.match_dates_id}|${r.locations_id}`;
                if (!groups.has(key)) groups.set(key, []);
                groups.get(key).push(r);
            });
            const groupKeys = Array.from(groups.keys()).sort((a, b) => {
                const [da] = a.split('|'), [db] = b.split('|');
                const sa = maps.dates.get(String(da)) || '', sb = maps.dates.get(String(db)) || '';
                return sa.localeCompare(sb);
            });

            el.result.innerHTML = groupKeys.map(key => {
                const [did, lid] = key.split('|');
                const list = groups.get(key).sort((a, b) => (a.time || '').localeCompare(b.time || ''));

                const dLabel = maps.datesLabel.get(String(did)) || maps.dates.get(String(did)) || '';
                const locName = maps.locs.get(String(lid)) || `場地ID:${lid}`;
                const gameTitle = (() => {
                    const set = new Set(list.map(x => x.games_id).filter(Boolean));
                    const ids = Array.from(set); if (!ids.length) return '';
                    return '｜ ' + ids.map(id => (maps.games.get(String(id)) || `賽事ID:${id}`)).filter(Boolean).join('、');
                })();

                const daySupervisorId = (list.find(x => !!x.supervisor_id)?.supervisor_id) || '';
                const people = peopleByDate[String(did)] || [];

                const supOpts = makePersonOptions(
                    (supervisors || []).map(s => ({ id: String(s.id), name: s.name })),
                    String(daySupervisorId || ''),
                    false
                );

                const body = list.map(r => {
                    const t1 = maps.teams.get(String(r.teams_id1)) || r.teams_id1 || '-';
                    const t2 = maps.teams.get(String(r.teams_id2)) || r.teams_id2 || '-';
                    const selHome = makePersonOptions(people, r.home_id);
                    const selB1 = makePersonOptions(people, r.base1_id);
                    const selB2 = makePersonOptions(people, r.base2_id);
                    const selB3 = makePersonOptions(people, r.base3_id);
                    const selRec = makePersonOptions(people, r.recorder_id);

                    return `
                            <tr data-id="${r.id}" data-time="${(r.time || '').slice(0, 5)}" data-loc="${lid}" data-date="${did}">
                                <td class="border px-2 py-1 text-center">${r.session || '-'}</td>
                                <td class="border px-2 py-1 text-center whitespace-nowrap">${(r.time || '').slice(0, 5) || '-'}</td>
                                <td class="border px-2 py-1 text-center">${t1}</td>
                                <td class="border px-2 py-1 text-center">VS</td>
                                <td class="border px-2 py-1 text-center">${t2}</td>

                                <td class="border px-2 py-1"><select name="home_id"     class="w-full border rounded px-2 py-1">${selHome}</select></td>
                                <td class="border px-2 py-1"><select name="base1_id"    class="w-full border rounded px-2 py-1">${selB1}</select></td>
                                <td class="border px-2 py-1"><select name="base2_id"    class="w-full border rounded px-2 py-1">${selB2}</select></td>
                                <td class="border px-2 py-1"><select name="base3_id"    class="w-full border rounded px-2 py-1">${selB3}</select></td>
                                <td class="border px-2 py-1"><select name="recorder_id" class="w-full border rounded px-2 py-1">${selRec}</select></td>

                                <td class="border px-2 py-1">
                                <input name="remark" type="text" class="w-full border rounded px-2 py-1" value="${(r.remark ?? '').replace(/"/g, '&quot;')}">
                                </td>
                            </tr>
                            `;
                }).join('');

                return `
                        <div class="group rounded-xl border border-blue-300 overflow-hidden" data-date="${did}" data-loc="${lid}">
                        <div class="bg-blue-50 px-4 py-3 font-semibold text-xl text-center">
                            ${dLabel} ${gameTitle} ｜ 地點：${locName}
                        </div>
                        <div class="overflow-x-auto">
                            <div class="min-w-[1100px]">
                            <table class="w-full text-lg bg-white text-center">
                                <thead class="bg-blue-100 text-blue-800">
                                <tr>
                                    <th class="border px-2 py-1">場次</th>
                                    <th class="border px-2 py-1">時間</th>
                                    <th class="border px-2 py-1">先攻</th>
                                    <th class="border px-2 py-1">VS</th>
                                    <th class="border px-2 py-1">後攻</th>
                                    <th class="border px-2 py-1">主審</th>
                                    <th class="border px-2 py-1">一壘審</th>
                                    <th class="border px-2 py-1">二壘審</th>
                                    <th class="border px-2 py-1">三壘審</th>
                                    <th class="border px-2 py-1">記錄</th>
                                    <th class="border px-2 py-1">備註</th>
                                </tr>
                                </thead>
                                <tbody data-date="${did}" data-loc="${lid}">
                                ${body}
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="px-4 py-3 border-t bg-slate-50 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex items-center gap-3">
                            <label class="font-semibold">監場：</label>
                            <select class="day-supervisor w-60 border rounded px-2 py-1" data-date="${did}" data-loc="${lid}">
                                ${supOpts}
                            </select>
                            </div>
                            <div class="flex items-center gap-4">
                            <div class="text-sm ${list.every(x => x.upload) ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${list.every(x => x.upload) ? '✔ 已上傳' : '✘ 尚未上傳'}
                            </div>
                            <div class="flex gap-3">
                                <button class="btn-save-day px-4 py-2 bg-green-600 text-white rounded" data-date="${did}" data-loc="${lid}">
                                儲存/取消上傳
                                </button>
                                <button class="btn-upload-day px-4 py-2 bg-blue-600 text-white rounded" data-date="${did}" data-loc="${lid}">
                                上傳
                                </button>
                            </div>
                            </div>
                        </div>
                        </div>
                    `;
            }).join('');

            el.result.querySelectorAll('select[name$="_id"]').forEach(attachNotePreview);
            el.result.querySelectorAll('.day-supervisor').forEach(attachNotePreview);

            const UNIQUE_KEYS = ['home_id', 'base1_id', 'base2_id', 'base3_id', 'recorder_id'];

            (function applyGuestSelections() {
                const ROLE_KEYS = ['home_id', 'base1_id', 'base2_id', 'base3_id', 'recorder_id'];

                el.result.querySelectorAll('tbody tr[data-id]').forEach(tr => {
                    const matchId = tr.getAttribute('data-id');

                    ROLE_KEYS.forEach(role => {
                        const key = `${String(matchId)}:${role}`;
                        const row = guestByKey.get(key);
                        if (!row) return;

                        guestPickMap.set(key, {
                            id: row.id || 'from-db',
                            name: row.guest_name,
                            note: row.guest_note || ''
                        });

                        const sel = tr.querySelector(`select[name="${role}"]`);
                        if (!sel) return;

                        const opt = document.createElement('option');
                        opt.value = `guest:${row.id || 'from-db'}`;
                        opt.textContent = `*${row.guest_name}`;
                        if (row.guest_note) opt.setAttribute('data-note', row.guest_note);

                        const addOpt = Array.from(sel.options).find(o => o.value === GUEST_ADD_VALUE);
                        if (addOpt) sel.insertBefore(opt, addOpt);
                        else sel.appendChild(opt);

                        sel.value = opt.value;
                        sel.dispatchEvent(new Event('change'));
                    });
                });
            })();

            function updateRowOptionLocks(tr) {
                const chosen = new Set(UNIQUE_KEYS.map(k => tr.querySelector(`select[name="${k}"]`)?.value).filter(Boolean));
                const tbody = tr.closest('tbody');
                const dateId = tbody?.getAttribute('data-date');
                const rowTime = tr.getAttribute('data-time');
                const currentLocId = tr.getAttribute('data-loc');

                UNIQUE_KEYS.forEach(k => {
                    const select = tr.querySelector(`select[name="${k}"]`);
                    if (!select) return;

                    Array.from(select.options).forEach(opt => opt.disabled = false);

                    Array.from(select.options).forEach(opt => {
                        if (!opt.value || String(opt.value).startsWith(GUEST_PREFIX)) return;
                        const duplicateInRow = chosen.has(opt.value) && opt.value !== select.value;
                        const crossVenue = hasCrossVenueConflict(dateId, opt.value, rowTime, currentLocId);
                        if (duplicateInRow || crossVenue) {
                            if (opt.value !== select.value) opt.disabled = true;
                        }
                    });
                });
            }

            function attachUniqueHandlersToRow(tr) {
                const tbody = tr.closest('tbody');
                const dateId = tbody?.getAttribute('data-date');
                const rowTime = tr.getAttribute('data-time');
                const currentLocId = tr.getAttribute('data-loc');
                const matchId = tr.getAttribute('data-id');

                const handleGuestAdd = (select, roleKey) => {
                    if (select.value !== GUEST_ADD_VALUE) return;

                    const name = (prompt('輸入臨時人員姓名：') || '').trim();
                    if (!name) { select.value = ''; return; }
                    const note = (prompt('備註（可留空）：') || '').trim();

                    const gid = uuid4();
                    const key = `${matchId}:${roleKey}`;
                    guestPickMap.set(key, { id: gid, name, note });

                    const opt = document.createElement('option');
                    opt.value = `${GUEST_PREFIX}${gid}`;
                    opt.textContent = `*${name}`;
                    opt.setAttribute('data-note', note);
                    const addOpt = Array.from(select.options).find(o => o.value === GUEST_ADD_VALUE);
                    if (addOpt) select.insertBefore(opt, addOpt); else select.appendChild(opt);
                    select.value = opt.value;

                    updateRowOptionLocks(tr);
                };

                UNIQUE_KEYS.forEach(k => {
                    const select = tr.querySelector(`select[name="${k}"]`);
                    if (!select) return;

                    select.addEventListener('change', () => {
                        if (select.value === GUEST_ADD_VALUE) {
                            handleGuestAdd(select, k);
                            return;
                        }

                        const val = select.value || '';
                        if (!val) { updateRowOptionLocks(tr); return; }

                        if (!String(val).startsWith(GUEST_PREFIX)) {
                            let conflictAt = '';
                            UNIQUE_KEYS.forEach(other => {
                                if (other === k) return;
                                const otherSel = tr.querySelector(`select[name="${other}"]`);
                                if (otherSel && otherSel.value && otherSel.value === val) conflictAt = other;
                            });
                            if (conflictAt) {
                                select.value = '';
                                updateRowOptionLocks(tr);
                                return alert('同一場的裁判/記錄不可重複。');
                            }

                            if (hasCrossVenueConflict(dateId, val, rowTime, currentLocId)) {
                                select.value = '';
                                updateRowOptionLocks(tr);
                                return alert(`同一天其他場地在 ${rowTime}（±${BUFFER_MIN} 分）已有該人員的指派。`);
                            }
                        }

                        updateRowOptionLocks(tr);
                    });
                });

                updateRowOptionLocks(tr);
            }

            el.result.querySelectorAll('tbody tr[data-id]').forEach(tr => attachUniqueHandlersToRow(tr));

            async function saveOneGroup(dateId, locId, uploadFlag) {
                const thresholdMinutes = 180;

                const groupEl = el.result.querySelector(`.group[data-date="${dateId}"][data-loc="${locId}"]`);
                if (!groupEl) { alert('找不到指定的表格'); return; }

                const tbody = groupEl.querySelector(`tbody[data-date="${dateId}"][data-loc="${locId}"]`);
                const supervisorSel = groupEl.querySelector(`.day-supervisor[data-date="${dateId}"][data-loc="${locId}"]`);
                const supervisor_id = supervisorSel ? (supervisorSel.value || null) : null;

                const trs = tbody.querySelectorAll('tr[data-id]');

                const UNIQUE_KEYS_LOCAL = ['home_id', 'base1_id', 'base2_id', 'base3_id', 'recorder_id'];
                for (const tr of trs) {
                    const picks = [];
                    UNIQUE_KEYS_LOCAL.forEach(k => {
                        const v = tr.querySelector(`select[name="${k}"]`)?.value || '';
                        if (v && !String(v).startsWith(GUEST_PREFIX)) picks.push({ k, v });
                    });
                    const seen = new Set();
                    for (const p of picks) {
                        if (seen.has(p.v)) {
                            alert('同一場比賽的裁判不可重複指派（裁判/記錄需為不同人）。\n請先修正再儲存/上傳。');
                            tr.querySelector(`select[name="${p.k}"]`)?.focus();
                            return;
                        }
                        seen.add(p.v);
                    }
                }

                const hhmmToMinutes = (hhmm) => {
                    if (!hhmm || !/^\d{2}:\d{2}/.test(hhmm)) return null;
                    const [h, m] = hhmm.split(':').map(n => parseInt(n, 10));
                    if (Number.isNaN(h) || Number.isNaN(m)) return null;
                    return h * 60 + m;
                };
                const nameOf = (uid) => {
                    const opt = tbody.querySelector(`select[name$="_id"] option[value="${uid}"]`);
                    return opt ? opt.textContent.trim() : `ID:${uid}`;
                };

                const currentDayAssignments = new Map();
                const matchMeta = new Map();

                trs.forEach(tr => {
                    const matchId = tr.getAttribute('data-id');
                    const timeText = tr.getAttribute('data-time') || tr.querySelector('td:nth-child(2)')?.textContent?.trim() || '';
                    const timeMin = hhmmToMinutes(timeText);
                    if (timeMin == null) return;

                    matchMeta.set(matchId, { time: timeText, locId: String(locId), locName: (maps.locs.get(String(locId)) || '') });

                    UNIQUE_KEYS_LOCAL.forEach(k => {
                        const uid = tr.querySelector(`select[name="${k}"]`)?.value || '';
                        if (!uid || String(uid).startsWith(GUEST_PREFIX)) return;
                        if (!currentDayAssignments.has(uid)) currentDayAssignments.set(uid, []);
                        currentDayAssignments.get(uid).push({ matchId, timeMin, locId: String(locId), source: 'DOM' });
                    });
                });

                const acc = conflictIndex.get(String(dateId)) || new Map();
                for (const [uid, recs] of currentDayAssignments.entries()) {
                    const others = acc.get(String(uid)) || [];
                    others.forEach(({ t, locId: otherLoc }) => {
                        if (String(otherLoc) !== String(locId)) recs.push({ matchId: `X-${t}-${otherLoc}`, timeMin: t, locId: String(otherLoc), source: 'DB' });
                    });

                    recs.sort((a, b) => a.timeMin - b.timeMin);
                    for (let i = 0; i < recs.length; i++) {
                        for (let j = i + 1; j < recs.length; j++) {
                            if (String(recs[i].locId) === String(recs[j].locId)) continue;
                            const dt = Math.abs(recs[i].timeMin - recs[j].timeMin);
                            if (dt < thresholdMinutes) {
                                const pName = nameOf(uid);
                                const m1 = matchMeta.get(recs[i].matchId);
                                const m2 = matchMeta.get(recs[j].matchId);
                                const m1Text = m1 ? `${m1.time} @ ${m1.locName}` : `比賽ID:${recs[i].matchId}`;
                                const m2Text = m2 ? `${m2.time} @ ${m2.locName}` : `比賽ID:${recs[j].matchId}`;
                                alert(`【跨場地時間衝突】\n裁判：${pName}\n${m1Text}\n與\n${m2Text}\n開賽時間相差小於 ${thresholdMinutes} 分鐘，請調整人員或時間後再儲存/上傳。`);
                                return;
                            }
                        }
                    }
                }

                const updates = [];
                const guestRows = [];
                const guestKeysToDelete = new Set();

                trs.forEach(tr => {
                    const matchId = String(tr.getAttribute('data-id'));
                    const payload = { upload: uploadFlag, supervisor_id };

                    UNIQUE_KEYS_LOCAL.forEach(k => {
                        const sel = tr.querySelector(`select[name="${k}"]`);
                        const v = sel ? (sel.value || null) : null;
                        const key = `${matchId}:${k}`;

                        if (v && String(v).startsWith(GUEST_PREFIX)) {
                            payload[k] = null;

                            const gp = guestPickMap.get(key);
                            if (gp && gp.name) {
                                guestRows.push({
                                    match_id: matchId,
                                    role: k,
                                    guest_name: gp.name,
                                    guest_note: gp.note || null,
                                });
                            }
                        } else {
                            payload[k] = v ? v : null;
                            guestKeysToDelete.add(key);
                            guestPickMap.delete(key);
                        }
                    });

                    const remark = tr.querySelector('input[name="remark"]')?.value ?? null;
                    payload.remark = (remark && remark.trim()) ? remark.trim() : null;
                    updates.push({ id: matchId, payload });
                });

                for (const u of updates) {
                    const { error: updErr } = await supabase.from('matches').update(u.payload).eq('id', u.id);
                    if (updErr) {
                        console.error('更新失敗 payload=', u.payload, 'err=', updErr);
                        alert('部分資料更新失敗（寫入 matches）。\n' + (updErr.message || ''));
                        return;
                    }
                }

                try {
                    for (const key of guestKeysToDelete) {
                        const [mid, role] = key.split(':');
                        await supabase.from('match_guest_assignments')
                            .delete()
                            .eq('match_id', mid)
                            .eq('role', role);
                    }
                } catch (e) {
                    console.warn('刪除舊臨時人員時例外（不影響 matches）：', e);
                }

                if (guestRows.length) {
                    try {
                        const uniqKeys = new Set(guestRows.map(g => `${g.match_id}:${g.role}`));
                        for (const key of uniqKeys) {
                            const [mid, role] = key.split(':');
                            await supabase.from('match_guest_assignments')
                                .delete()
                                .eq('match_id', mid)
                                .eq('role', role);
                        }
                        const { error: insErr } = await supabase.from('match_guest_assignments').insert(guestRows);
                        if (insErr) {
                            console.warn('寫入臨時人員失敗（不影響 matches）：', insErr);
                        }
                    } catch (e) {
                        console.warn('寫入臨時人員時例外（不影響 matches）：', e);
                    }
                }

                showToast(uploadFlag ? '上傳完成！(已將本日裁判表上傳至裁判員頁面)' : '儲存/取消上傳成功！', 'success');

                const currentDate = el.date.value || null;
                const currentLoc = el.loc.value || null;
                runQuery({ dateId: currentDate, locId: currentLoc });
            }

            el.result.addEventListener('click', (e) => {
                const saveBtn = e.target.closest('.btn-save-day');
                if (saveBtn) { saveOneGroup(saveBtn.dataset.date, saveBtn.dataset.loc, false); return; }
                const uploadBtn = e.target.closest('.btn-upload-day');
                if (uploadBtn) { saveOneGroup(uploadBtn.dataset.date, uploadBtn.dataset.loc, true); }
            });

            el.tip.textContent = `共 ${rows.length} 場比賽。`;
        }
    });

    document.getElementById('btn-view-registrations').addEventListener('click', async () => {
        contentArea.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">查看報名狀況</h2>
                <div class="space-y-6">
                <!-- 搜尋方式置中 -->
                <div class="flex flex-col items-center" id="query-options">
                    <label class="block font-semibold mb-2">查詢方式：</label>
                    <div id="query-mode" class="inline-flex rounded-lg overflow-hidden border border-blue-300">
                    <button type="button" data-mode="date"
                            class="px-4 py-2 text-sm font-medium bg-blue-600 text-white">
                        依日期
                    </button>
                    <button type="button" data-mode="user"
                            class="px-4 py-2 text-sm font-medium bg-white text-blue-900 hover:bg-blue-50">
                        依報名者
                    </button>
                    </div>
                </div>

                <!-- 右側選單 -->
                <div id="query-select-box" class="max-w-md mx-auto w-full"></div>

                <!-- 查詢結果 -->
                <div id="query-result-area" class="text-blue-900"></div>
                </div>
            `;

        const queryModeWrap = document.getElementById('query-mode');
        const querySelectBox = document.getElementById('query-select-box');
        const queryResultArea = document.getElementById('query-result-area');

        const [datesRes, usersRes] = await Promise.all([
            supabase.from('match_dates').select('id, date').order('date'),
            supabase.from('profiles').select('id, name').order('name'),
        ]);
        const allDates = datesRes.error ? [] : (datesRes.data || []);
        const allUsers = usersRes.error ? [] : (usersRes.data || []);

        const fmtTW = (d) => new Date(d).toLocaleDateString('zh-TW', {
            year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
        });

        function renderRightSelector(type) {
            queryResultArea.innerHTML = '';

            if (type === 'date') {
                querySelectBox.innerHTML = `
                        <label class="block font-semibold mb-2">選擇比賽日期：</label>
                        <select id="date-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">請選擇</option>
                        ${allDates.map(d => `<option value="${d.id}">${fmtTW(d.date)}</option>`).join('')}
                        </select>
                    `;
                document.getElementById('date-select').addEventListener('change', (e) => loadByDate(e.target.value));
            } else {
                querySelectBox.innerHTML = `
                        <label class="block font-semibold mb-2">選擇報名者：</label>
                        <select id="user-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">請選擇</option>
                        ${allUsers.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                        </select>
                    `;
                document.getElementById('user-select').addEventListener('change', (e) => loadByUser(e.target.value));
            }
        }

        async function loadByDate(dateId) {
            queryResultArea.innerHTML = '';
            if (!dateId) return;

            const { data, error } = await supabase
                .from('registrations')
                .select('description, user_id, match_date_id, profiles(name)')
                .eq('match_date_id', dateId);

            if (error) {
                queryResultArea.innerHTML = `<p class="text-red-500 font-medium">查詢失敗，請稍後再試。</p>`;
                return;
            }
            if (!data || data.length === 0) {
                queryResultArea.innerHTML = `<p class="text-gray-500 font-medium">目前尚無人報名此日期。</p>`;
                return;
            }

            queryResultArea.innerHTML = `
                    <table class="w-full border border-blue-300 text-sm text-left mt-4">
                        <thead class="bg-blue-100 text-blue-800">
                        <tr>
                            <th class="border px-4 py-2 w-32">姓名</th>
                            <th class="border px-4 py-2">備註</th>
                            <th class="border px-4 py-2 w-20">操作</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white">
                        ${data.map((r, i) => `
                            <tr>
                            <td class="border px-4 py-2">${r.profiles?.name || '-'}</td>
                            <td class="border px-4 py-2">${r.description || '無'}</td>
                            <td class="border px-4 py-2">
                                <div class="flex justify-center items-center gap-3">
                                <button onclick="editRemarkByRow(${i})"
                                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
                                        title="修改備註">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteRegistrationByRow(${i})"
                                        class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition"
                                        title="刪除報名">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                </div>
                            </td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                    `;
            window.latestDateRegData = data;
        }

        async function loadByUser(userId) {
            queryResultArea.innerHTML = '';
            if (!userId) return;

            let { data, error } = await supabase
                .from('registrations')
                .select('description, match_dates(id, date), user_id, match_date_id')
                .eq('user_id', userId);

            if (error) {
                queryResultArea.innerHTML = `<p class="text-red-500 font-medium">查詢失敗，請稍後再試。</p>`;
                return;
            }

            data = data || [];
            data.sort((a, b) => new Date(a.match_dates.date) - new Date(b.match_dates.date));

            if (data.length === 0) {
                queryResultArea.innerHTML = `<p class="text-gray-500 font-medium">尚未報名任何場次。</p>`;
            } else {
                queryResultArea.innerHTML = `
                        <table class="w-full border border-blue-300 text-sm text-left mt-4">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                            <th class="border px-4 py-2 w-44">日期</th>
                            <th class="border px-4 py-2">備註</th>
                            <th class="border px-4 py-2 w-20">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            ${data.map((r, i) => `
                            <tr>
                                <td class="border px-4 py-2">${fmtTW(r.match_dates.date)}</td>
                                <td class="border px-4 py-2">${r.description || '無'}</td>
                                <td class="border px-4 py-2">
                                <div class="flex justify-center items-center gap-3">
                                    <button onclick="editRemark(${i})"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
                                            title="修改備註">
                                    <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteRegistration(${i})"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition"
                                            title="刪除報名">
                                    <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                        </table>
                    `;
                window.latestUserRegData = data;
            }

            const registeredIds = data.map(r => r.match_date_id);
            const availableDates = allDates
                .filter(d => !registeredIds.includes(d.id))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (availableDates.length === 0) {
                queryResultArea.innerHTML += `<p class="text-gray-500 mt-6 font-medium">此使用者已報名所有場次。</p>`;
            } else {
                queryResultArea.innerHTML += `
                        <div class="mt-10 pt-6 border-t border-blue-200">
                        <h3 class="text-lg font-bold mb-4">為該使用者新增報名場次</h3>
                        <form id="admin-add-form" class="space-y-4">
                            ${availableDates.map(d => `
                            <div class="flex items-center gap-4">
                                <input type="checkbox" id="chk-${d.id}" name="dates" value="${d.id}" class="w-5 h-5 text-blue-600" />
                                <label for="chk-${d.id}" class="w-48 font-medium">${fmtTW(d.date)}</label>
                                <input type="text" name="note-${d.id}" placeholder="備註（可不填）"
                                    class="flex-1 px-3 py-1.5 border rounded bg-white text-blue-900" />
                            </div>
                            `).join('')}
                            <div class="text-right">
                            <button type="submit"
                                    class="mt-4 px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                送出新增
                            </button>
                            </div>
                        </form>
                        </div>
                    `;

                document.getElementById('admin-add-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const checked = Array.from(document.querySelectorAll('input[name="dates"]:checked'));
                    if (checked.length === 0) return alert('請勾選至少一個比賽日期');

                    const insertData = checked.map(cb => {
                        const id = cb.value;
                        const note = document.querySelector(`input[name="note-${id}"]`)?.value.trim() || '';
                        return {
                            user_id: userId,
                            match_date_id: id,
                            description: note,
                            registred_at: new Date().toISOString()
                        };
                    });

                    const { error: insertErr } = await supabase.from('registrations').insert(insertData);
                    if (insertErr) {
                        alert('新增失敗，請稍後再試');
                        console.error(insertErr);
                    } else {
                        alert('新增成功');
                        loadByUser(userId);
                    }
                });
            }
        }

        queryModeWrap.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-mode]');
            if (!btn) return;
            queryModeWrap.querySelectorAll('button').forEach(b => {
                b.classList.toggle('bg-blue-600', b === btn);
                b.classList.toggle('text-white', b === btn);
                b.classList.toggle('bg-white', b !== btn);
                b.classList.toggle('text-blue-900', b !== btn);
            });
            renderRightSelector(btn.dataset.mode);
        });

        renderRightSelector('date');
    });

    async function editRemarkByRow(index) {
        const row = window.latestDateRegData[index];
        const oldRemark = row.description || '';
        const newRemark = prompt('請輸入新的備註：', oldRemark);
        if (newRemark === null) return;

        const { error } = await supabase
            .from('registrations')
            .update({ description: newRemark })
            .match({
                user_id: row.user_id,
                match_date_id: row.match_date_id
            });

        if (error) {
            alert('更新失敗，請稍後再試');
        } else {
            alert('更新成功');
            document.getElementById('date-select').dispatchEvent(new Event('change'));
        }
    }
    async function deleteRegistrationByRow(index) {
        const row = window.latestDateRegData[index];
        const confirmDelete = confirm(`確定要刪除 ${row.profiles.name} 的報名紀錄嗎？`);
        if (!confirmDelete) return;

        const { error } = await supabase
            .from('registrations')
            .delete()
            .match({
                user_id: row.user_id,
                match_date_id: row.match_date_id
            });

        if (error) {
            alert('刪除失敗，請稍後再試');
        } else {
            alert('刪除成功');
            document.getElementById('date-select').dispatchEvent(new Event('change'));
        }
    }
    async function editRemark(index) {
        const row = window.latestUserRegData[index];
        const oldRemark = row.description || '';
        const newRemark = prompt('請輸入新的備註：', oldRemark);
        if (newRemark === null) return;
        console.log('Updating...', {
            user_id: row.user_id,
            match_date_id: row.match_date_id,
            description: newRemark
        });

        const { error } = await supabase
            .from('registrations')
            .update({ description: newRemark })
            .match({
                user_id: row.user_id,
                match_date_id: row.match_date_id
            });

        if (error) {
            alert('更新失敗，請稍後再試');
        } else {
            alert('更新成功');
            document.getElementById('user-select').dispatchEvent(new Event('change')); // 重新載入
        }
    }
    async function deleteRegistration(index) {
        const row = window.latestUserRegData[index];
        const confirmDelete = confirm(`確定要刪除報名日期：${new Date(row.match_dates.date).toLocaleDateString('zh-TW')} 的紀錄嗎？`);
        if (!confirmDelete) return;

        const { error } = await supabase
            .from('registrations')
            .delete()
            .match({
                user_id: row.user_id,
                match_date_id: row.match_date_id
            });

        if (error) {
            alert('刪除失敗，請稍後再試');
        } else {
            alert('刪除成功');
            document.getElementById('user-select').dispatchEvent(new Event('change')); // 重新載入資料
        }
    }

    document.getElementById('btn-add-match-date').addEventListener('click', async () => {
            contentArea.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">新增賽程</h2>

                <form id="match-form" class="space-y-6">
                <!-- 賽事 -->
                <div>
                    <label class="block font-semibold mb-2">賽事名稱</label>
                    <select id="games-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                    </select>
                </div>

                <!-- 日期、地點 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                    <label class="block font-semibold mb-2">日期</label>
                    <select id="date-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">載入中...</option>
                    </select>
                    </div>
                    <div>
                    <label class="block font-semibold mb-2">地點</label>
                    <select id="loc-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">載入中...</option>
                    </select>
                    </div>
                </div>

                <!-- 編號、時間 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                    <label class="block font-semibold mb-2">編號（場次）</label>
                    <input id="session-input" type="text" placeholder="例：A1 或 1"
                            class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
                    </div>
                    <div>
                    <label class="block font-semibold mb-2">時間</label>
                    <input id="time-input" type="time"
                            class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
                    </div>
                </div>

                <!-- 先攻 / 後攻 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                    <label class="block font-semibold mb-2">先攻隊伍</label>
                    <select id="team1-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">請先選擇賽事</option>
                    </select>
                    </div>
                    <div>
                    <label class="block font-semibold mb-2">後攻隊伍</label>
                    <select id="team2-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">請先選擇賽事</option>
                    </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    新增賽程
                    </button>
                </div>
                </form>

                <!-- 搜尋區塊 -->
                <div class="mt-10 pt-6 border-t border-blue-200">
                <h3 class="text-xl font-bold mb-4">查詢賽程</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div>
                    <label class="block font-semibold mb-2">賽事</label>
                    <select id="q-game" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">載入中...</option>
                    </select>
                    </div>
                    <div>
                    <label class="block font-semibold mb-2">地點</label>
                    <select id="q-loc" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                        <option value="">載入中...</option>
                    </select>
                    </div>
                    <div class="flex sm:block">
                    <button id="btn-query" class="w-full px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">查詢</button>
                    </div>
                </div>
                <div id="search-tip" class="text-sm text-blue-700 mt-2"></div>
                <div id="search-result" class="mt-6 space-y-8"></div>
                </div>

                <div id="match-tip" class="text-sm text-blue-700 mt-2"></div>
            `;

            const el = {
                form: document.getElementById('match-form'),
                games: document.getElementById('games-select'),
                date: document.getElementById('date-select'),
                loc: document.getElementById('loc-select'),
                session: document.getElementById('session-input'),
                time: document.getElementById('time-input'),
                team1: document.getElementById('team1-select'),
                team2: document.getElementById('team2-select'),
                tip: document.getElementById('match-tip'),
                // 搜尋
                qGame: document.getElementById('q-game'),
                qLoc: document.getElementById('q-loc'),
                btnQuery: document.getElementById('btn-query'),
                searchTip: document.getElementById('search-tip'),
                searchResult: document.getElementById('search-result'),
            };

            const maps = {
                games: new Map(),
                dates: new Map(),
                datesLabel: new Map(),
                locs: new Map(),
                teams: new Map(),
                profiles: new Map(),
            };

            const LS_MATCH_DEFAULTS = 'match_new_defaults';

            function saveMatchDefaults({ games_id, match_dates_id, locations_id }) {
                const payload = {
                    games_id: String(games_id || ''),
                    match_dates_id: String(match_dates_id || ''),
                    locations_id: String(locations_id || ''),
                };
                localStorage.setItem(LS_MATCH_DEFAULTS, JSON.stringify(payload));
            }

            function loadMatchDefaults() {
                try {
                    const raw = localStorage.getItem(LS_MATCH_DEFAULTS);
                    return raw ? JSON.parse(raw) : null;
                } catch {
                    return null;
                }
            }

            let currentEditId = null;

            function exitEditMode() {
                currentEditId = null;
                el.form.reset();
                el.games.dispatchEvent(new Event('change'));
                const submitBtn = el.form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = '新增賽程';
                const cancelBtn = document.getElementById('btn-cancel-edit');
                if (cancelBtn) cancelBtn.remove();
            }

            async function fillFormFromMatch(row) {
                el.games.value = row.games_id || '';
                await loadTeamsByGame(el.games.value);

                el.date.value = row.match_dates_id || '';
                el.loc.value = row.locations_id || '';
                el.session.value = row.session || '';
                el.time.value = (row.time || '').slice(0, 5);
                el.team1.value = row.teams_id1 || '';
                el.team2.value = row.teams_id2 || '';

                const submitBtn = el.form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = '儲存修改';

                if (!document.getElementById('btn-cancel-edit')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.id = 'btn-cancel-edit';
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'px-4 py-2 border rounded hover:bg-blue-50';
                    cancelBtn.textContent = '取消修改';
                    submitBtn.parentElement.prepend(cancelBtn);
                    cancelBtn.addEventListener('click', exitEditMode);
                }
            }

            async function loadStaticOptions() {
                el.tip.textContent = '載入選單中...';

                const [gamesRes, datesRes, locsRes] = await Promise.all([
                    supabase.from('games').select('id, name').order('name', { ascending: true }),
                    supabase.from('match_dates').select('id, date').order('date', { ascending: true }),
                    supabase.from('locations').select('id, name').order('name', { ascending: true })
                ]);

                if (gamesRes.error) {
                    el.games.innerHTML = `<option value="">載入賽事失敗</option>`;
                    el.qGame.innerHTML = `<option value="">載入賽事失敗</option>`;
                    console.error(gamesRes.error);
                } else {
                    const opts = (gamesRes.data || []);
                    el.games.innerHTML = `<option value="">請選擇賽事</option>` +
                        opts.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                    el.qGame.innerHTML = `<option value="">請選擇賽事</option>` +
                        opts.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                    maps.games.clear();
                    opts.forEach(g => maps.games.set(String(g.id), g.name));
                }

                if (datesRes.error) {
                    el.date.innerHTML = `<option value="">載入日期失敗</option>`;
                    console.error(datesRes.error);
                } else {
                    const opts = (datesRes.data || []);
                    el.date.innerHTML = `<option value="">請選擇日期</option>` +
                        opts.map(d => {
                            const iso = String(d.date).slice(0, 10);
                            const label = new Date(d.date).toLocaleDateString('zh-TW', {
                                year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short'
                            });
                            maps.dates.set(String(d.id), iso);
                            maps.datesLabel.set(String(d.id), label);
                            return `<option value="${d.id}">${label}</option>`;
                        }).join('');
                }

                if (locsRes.error) {
                    el.loc.innerHTML = `<option value="">載入地點失敗</option>`;
                    el.qLoc.innerHTML = `<option value="">載入地點失敗</option>`;
                    console.error(locsRes.error);
                } else {
                    const opts = (locsRes.data || []);
                    el.loc.innerHTML = `<option value="">請選擇地點</option>` +
                        opts.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                    el.qLoc.innerHTML = `<option value="">請選擇地點</option>` +
                        opts.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
                    maps.locs.clear();
                    opts.forEach(l => maps.locs.set(String(l.id), l.name));
                }

                await applySavedDefaults();
                applySavedDefaultsToQuery();
                el.tip.textContent = '';
            }

            async function loadTeamsByGame(gameId) {
                if (!gameId) {
                    el.team1.innerHTML = `<option value="">請先選擇賽事</option>`;
                    el.team2.innerHTML = `<option value="">請先選擇賽事</option>`;
                    return;
                }
                const { data, error } = await supabase
                    .from('teams')
                    .select('id, name')
                    .eq('games_id', gameId)
                    .order('name', { ascending: true });

                if (error) {
                    console.error(error);
                    el.team1.innerHTML = `<option value="">載入隊伍失敗</option>`;
                    el.team2.innerHTML = `<option value="">載入隊伍失敗</option>`;
                    return;
                }

                const options = `<option value="">請選擇隊伍</option>` +
                    (data || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                el.team1.innerHTML = options;
                el.team2.innerHTML = options;

                maps.teams.clear();
                (data || []).forEach(t => maps.teams.set(String(t.id), t.name));
            }

            async function applySavedDefaults() {
                const d = loadMatchDefaults();
                if (!d) return;

                if (d.games_id && el.games.querySelector(`option[value="${d.games_id}"]`)) {
                    el.games.value = d.games_id;
                    await loadTeamsByGame(d.games_id);
                } else {
                    return;
                }

                if (d.match_dates_id && el.date.querySelector(`option[value="${d.match_dates_id}"]`)) {
                    el.date.value = d.match_dates_id;
                }
                if (d.locations_id && el.loc.querySelector(`option[value="${d.locations_id}"]`)) {
                    el.loc.value = d.locations_id;
                }
            }

            function applySavedDefaultsToQuery() {
                const d = loadMatchDefaults();
                if (!d) return;
                if (d.games_id && el.qGame.querySelector(`option[value="${d.games_id}"]`)) {
                    el.qGame.value = d.games_id;
                }
                if (d.locations_id && el.qLoc.querySelector(`option[value="${d.locations_id}"]`)) {
                    el.qLoc.value = d.locations_id;
                }
            }

            el.games.addEventListener('change', () => loadTeamsByGame(el.games.value));

            el.form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const payload = {
                    games_id: el.games.value || null,
                    match_dates_id: el.date.value || null,
                    locations_id: el.loc.value || null,
                    session: (el.session.value || '').trim(),
                    time: el.time.value || null,
                    teams_id1: el.team1.value || null,
                    teams_id2: el.team2.value || null,
                    home_id: null, base1_id: null, base2_id: null, base3_id: null,
                    recorder_id: null, supervisor_id: null,
                    remark: null,
                    upload: false
                };

                if (!payload.games_id) return alert('請選擇賽事');
                if (!payload.match_dates_id) return alert('請選擇日期');
                if (!payload.locations_id) return alert('請選擇地點');
                if (!payload.session) return alert('請輸入場次編號');
                if (!payload.time) return alert('請選擇時間');
                if (!payload.teams_id1 || !payload.teams_id2) return alert('請選擇先攻與後攻隊伍');
                if (payload.teams_id1 === payload.teams_id2) return alert('先攻與後攻隊伍不可相同');

                const { data: chkTeams, error: chkErr } = await supabase
                    .from('teams')
                    .select('id, games_id')
                    .in('id', [payload.teams_id1, payload.teams_id2]);

                if (chkErr) { console.error(chkErr); return alert('驗證隊伍所屬賽事失敗，請稍後再試'); }
                const ok = Array.isArray(chkTeams) && chkTeams.length === 2 &&
                    chkTeams.every(t => String(t.games_id) === String(payload.games_id));
                if (!ok) return alert('所選隊伍不屬於同一賽事，請重新選擇');

                if (currentEditId) {
                    const { error: updErr } = await supabase
                        .from('matches')
                        .update(payload)
                        .eq('id', currentEditId);

                    if (updErr) {
                        console.error(updErr);
                        alert('更新失敗，請稍後再試');
                    } else {
                        alert('更新成功！');
                        exitEditMode();
                        if (el.qGame.value && el.qLoc.value) el.btnQuery.click();
                    }
                } else {
                    const { error: insErr } = await supabase.from('matches').insert(payload);
                    if (insErr) {
                        console.error(insErr);
                        alert('新增賽程失敗，請稍後再試');
                    } else {
                        alert('賽程新增成功！');

                        saveMatchDefaults({
                            games_id: el.games.value,
                            match_dates_id: el.date.value,
                            locations_id: el.loc.value,
                        });

                        el.session.value = '';
                        el.time.value = '';
                        el.team1.value = '';
                        el.team2.value = '';
                        el.session.focus();
                    }
                }
            });

            el.btnQuery.addEventListener('click', async () => {
                const gameId = el.qGame.value;
                const locId = el.qLoc.value;

                if (!gameId) return alert('請選擇要查詢的賽事');
                if (!locId) return alert('請選擇要查詢的地點');

                el.searchTip.textContent = '查詢中...';
                el.searchResult.innerHTML = '';

                const { data: rows, error } = await supabase
                    .from('matches')
                    .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2')
                    .eq('games_id', gameId)
                    .eq('locations_id', locId);

                if (error) {
                    console.error(error);
                    el.searchTip.textContent = '查詢失敗，請稍後再試';
                    return;
                }

                if (!rows || rows.length === 0) {
                    el.searchTip.textContent = '沒有資料。';
                    return;
                }

                const teamIds = new Set();
                rows.forEach(r => {
                    if (r.teams_id1) teamIds.add(r.teams_id1);
                    if (r.teams_id2) teamIds.add(r.teams_id2);
                });
                if (teamIds.size > 0) {
                    const { data: teamList, error: teamErr } = await supabase
                        .from('teams')
                        .select('id, name')
                        .in('id', Array.from(teamIds));
                    if (!teamErr && teamList) {
                        teamList.forEach(t => maps.teams.set(String(t.id), t.name));
                    }
                }

                const byDate = {};
                rows.forEach(r => {
                    const iso = maps.dates.get(String(r.match_dates_id)) || '未知日期';
                    if (!byDate[iso]) byDate[iso] = [];
                    byDate[iso].push(r);
                });

                const dateKeys = Object.keys(byDate).sort();
                dateKeys.forEach(d => {
                    byDate[d].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                });

                const gameName = maps.games.get(String(gameId)) || '';
                const locName = maps.locs.get(String(locId)) || '';

                el.searchResult.innerHTML = dateKeys.map(d => {
                    const dLabel = [...maps.datesLabel.entries()]
                        .find(([id, lbl]) => maps.dates.get(id) === d)?.[1] || d;

                    const rowsHtml = byDate[d].map(r => {
                        const t1 = maps.teams.get(String(r.teams_id1)) || r.teams_id1 || '-';
                        const t2 = maps.teams.get(String(r.teams_id2)) || r.teams_id2 || '-';
                        const time = r.time || '-';
                        const session = r.session || '-';
                        const confirmText = `確定刪除：
                                            日期：${dLabel}
                                            賽事：${gameName}
                                            地點：${locName}
                                            時間：${time}
                                            場次：${session}
                                            對戰：${t1} vs ${t2}
                                            此操作無法復原。`;
                        return `
                            <tr data-id="${r.id}">
                                <td class="border px-3 py-2 text-center">${session}</td>
                                <td class="border px-3 py-2 text-center whitespace-nowrap">${time}</td>
                                <td class="border px-3 py-2 text-center">${t1}</td>
                                <td class="border px-3 py-2 text-center">vs</td>
                                <td class="border px-3 py-2 text-center">${t2}</td>
                                <td class="border px-3 py-2 text-center">
                                <button
                                    class="btn-edit-match inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"
                                    title="修改"
                                    data-id="${r.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button
                                    class="btn-del-match inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200"
                                    title="刪除"
                                    data-id="${r.id}"
                                    data-confirm="${confirmText.replace(/"/g, '&quot;')}"
                                >
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                </td>
                            </tr>
                            `;
                    }).join('');

                    return `
                        <div class="rounded-xl border border-blue-300 overflow-hidden">
                        <div class="bg-blue-50 px-4 py-3 font-semibold text-center">
                            ${dLabel} ｜ ${gameName} ｜ 地點：${locName}
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm bg-white text-center">
                            <thead class="bg-blue-100 text-blue-800">
                                <tr>
                                <th class="border px-3 py-2 text-center">場次</th>
                                <th class="border px-3 py-2 text-center">時間</th>
                                <th class="border px-3 py-2 text-center">先攻</th>
                                <th class="border px-3 py-2 text-center">VS</th>
                                <th class="border px-3 py-2 text-center">後攻</th>
                                <th class="border px-3 py-2 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                            </table>
                        </div>
                        </div>
                    `;
                }).join('');

                el.searchResult.querySelectorAll('.btn-del-match').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const msg = btn.getAttribute('data-confirm') || '確定刪除？此操作無法復原。';
                        if (!confirm(msg)) return;

                        const { error: delErr } = await supabase.from('matches').delete().eq('id', id);
                        if (delErr) {
                            console.error(delErr);
                            alert('刪除失敗，請稍後再試');
                        } else {
                            el.btnQuery.click();
                        }
                    });
                });

                el.searchResult.querySelectorAll('.btn-edit-match').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const { data, error } = await supabase
                            .from('matches')
                            .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2')
                            .eq('id', id)
                            .single();

                        if (error || !data) {
                            console.error(error);
                            alert('讀取資料失敗，請稍後再試');
                            return;
                        }

                        currentEditId = id;
                        await fillFormFromMatch(data);
                        el.form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                });

                el.searchTip.textContent = `共 ${rows.length} 場比賽。`;
            });

            await loadStaticOptions();
        });

    document.getElementById('logout-btn').addEventListener('click', function () {
        localStorage.removeItem('profile');
        window.location.href = 'index.html';
    });

    document.getElementById('btn-schedule').click();
</script>

</html>