<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç³»çµ± | è£åˆ¤å‡ºå‹¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">è£åˆ¤å‡ºå‹¤ç³»çµ±</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">æ‚¨å¥½!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>ä¿®æ”¹å¯†ç¢¼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>ç™»å‡º
                </button>
            </div>
        </div>

        <div
            class="bg-white/90 border-2 border-blue-400/40 backdrop-blur-md rounded-2xl shadow-2xl p-12 w-full max-w-xl mx-auto">
            <!-- æŸ¥è©¢ by æ—¥æœŸ -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-blue-900 mb-2" for="date-select">é¸æ“‡æ¯”è³½æ—¥æœŸï¼š</label>
                <select id="date-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 text-blue-900">
                    <option value="">è«‹é¸æ“‡</option>
                </select>
                <div id="date-result" class="mt-4 text-blue-800"></div>
            </div>
            
            <!-- æŸ¥è©¢ by ä½¿ç”¨è€… -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-blue-900 mb-2" for="user-select">é¸æ“‡å ±åè€…ï¼š</label>
                <select id="user-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 text-blue-900">
                    <option value="">è«‹é¸æ“‡</option>
                </select>
                <div id="user-result" class="mt-4 text-blue-800"></div>
            </div>
            
            <div class="flex justify-center mt-4" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>è¿”å›é¦–é 
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                è£åˆ¤å‡ºå‹¤ç³»çµ±
            </small>
        </div>
    </div>
</body>
<script>
    const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

    const profileStr = localStorage.getItem('profile');
    if (profileStr) {
        const profile = JSON.parse(profileStr);
        const roleText = profile.role === 'admin' ? 'ç®¡ç†å“¡'
            : profile.role === 'member' ? 'è£åˆ¤å“¡' : 'ï¼ˆæœªçŸ¥èº«ä»½ï¼‰';

        document.getElementById('welcome-title').innerText = `${profile.name || ''} æ‚¨å¥½ !`;
        document.getElementById('profile-info').innerHTML = `
            <div>${roleText}</div>
        `;
    }
    document.addEventListener('DOMContentLoaded', async () => {
            // å–å¾—æ‰€æœ‰æ¯”è³½æ—¥æœŸ
            const { data: matchDates, error: dateError } = await supabase
                .from('match_dates')
                .select('id, date')
                .order('date');

            if (dateError) {
                console.error('âŒ è¼‰å…¥æ¯”è³½æ—¥æœŸå¤±æ•—', dateError);
                return;
            }

            const dateSelect = document.getElementById('date-select');
            matchDates.forEach(d => {
                const opt = document.createElement('option');
                const dateStr = new Date(d.date).toLocaleDateString('zh-TW', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                });
                opt.value = d.id;
                opt.textContent = dateStr;
                dateSelect.appendChild(opt);
            });

            // å–å¾—æ‰€æœ‰å ±åè€…
            const { data: users, error: userError } = await supabase
                .from('profiles')
                .select('id, name')
                .order('name');

            if (userError) {
                console.error('âŒ è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—', userError);
                return;
            }

            const userSelect = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = u.name;
                userSelect.appendChild(opt);
            });
        });

        // ğŸ” æŸ¥è©¢é¸å®šæ—¥æœŸçš„å ±åè€…
        document.getElementById('date-select').addEventListener('change', async function () {
            const dateId = this.value;
            const resultDiv = document.getElementById('date-result');
            resultDiv.innerHTML = '';

            if (!dateId) return;

            const { data, error } = await supabase
                .from('registrations')
                .select('description, profiles(name)')
                .eq('match_date_id', dateId);

            if (error) {
                console.error('âŒ æŸ¥è©¢å¤±æ•—', error);
                resultDiv.innerHTML = '<p class="text-red-500">æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
                return;
            }

            if (data.length === 0) {
                resultDiv.innerHTML = '<p class="text-gray-500">ç›®å‰å°šç„¡äººå ±åæ­¤æ—¥æœŸã€‚</p>';
                return;
            }

            resultDiv.innerHTML = `
        <ul class="list-disc pl-6">
            ${data.map(r => `<li>${r.profiles.name}ï¼ˆ${r.description || 'ç„¡å‚™è¨»'}ï¼‰</li>`).join('')}
        </ul>`;
        });

        // ğŸ” æŸ¥è©¢é¸å®šä½¿ç”¨è€…çš„å ±åæ—¥æœŸ
        document.getElementById('user-select').addEventListener('change', async function () {
            const userId = this.value;
            const resultDiv = document.getElementById('user-result');
            resultDiv.innerHTML = '';

            if (!userId) return;

            const { data, error } = await supabase
                .from('registrations')
                .select('description, match_dates(date)')
                .eq('user_id', userId);

            if (error) {
                console.error('âŒ æŸ¥è©¢å¤±æ•—', error);
                resultDiv.innerHTML = '<p class="text-red-500">æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
                return;
            }

            if (data.length === 0) {
                resultDiv.innerHTML = '<p class="text-gray-500">æ­¤ä½¿ç”¨è€…å°šæœªå ±åä»»ä½•å ´æ¬¡ã€‚</p>';
                return;
            }

            resultDiv.innerHTML = `
        <ul class="list-disc pl-6">
            ${data.map(r => {
                const dateStr = new Date(r.match_dates.date).toLocaleDateString('zh-TW', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                });
                return `<li>${dateStr}ï¼ˆ${r.description || 'ç„¡å‚™è¨»'}ï¼‰</li>`;
            }).join('')}
        </ul>`;
        });

    document.getElementById('logout-btn').addEventListener('click', function () {
        localStorage.removeItem('profile');
        window.location.href = 'index.html';
    });
</script>


</html>