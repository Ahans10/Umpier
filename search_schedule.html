<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班表查詢 | 裁判出勤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">裁判出勤系統</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">您好!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>修改密碼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </button>
            </div>
        </div>

        <div id="content-inner"
            class="mt-8 max-w-7xl mx-auto bg-white/90 border border-blue-300 rounded-2xl shadow p-8 text-blue-900 flex flex-col gap-6">

            <div id="content-area"></div>

            <div class="flex justify-center" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>返回首頁
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                裁判出勤系統
            </small>
        </div>
    </div>
</body>
<script>
    const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

    const profileStr = localStorage.getItem('profile');
    if (profileStr) {
        const profile = JSON.parse(profileStr);
        const roleText = profile.role === 'admin' ? '管理員'
            : profile.role === 'member' ? '裁判員' : '（未知身份）';

        document.getElementById('welcome-title').innerText = `${profile.name || ''} 您好 !`;
        document.getElementById('profile-info').innerHTML = `
            <div>${roleText}</div>
        `;
    }

    (async function myScheduleByRegistration() {
            if (!window.supabase) { alert('Supabase 尚未載入'); return; }
            const profileStr = localStorage.getItem('profile');
            if (!profileStr) { window.location.href = 'index.html'; return; }
            const me = JSON.parse(profileStr);
            const myId = String(me.id || me.user_id || '');

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold mb-8 text-center text-blue-900">我的班表</h2>
                <div id="my-tip" class="text-lg text-center font-medium text-blue-700 mb-4">讀取你報名的日期與班表中…</div>
                <div id="my-result" class="space-y-10"></div>
            `;

            if (!window.html2canvas) {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(s);
                await new Promise(res => s.onload = res);
            }

            const el = {
                tip: document.getElementById('my-tip'),
                result: document.getElementById('my-result'),
            };

            el.tip.textContent = '讀取你報名的日期中...';
            const { data: regis, error: regErr } = await supabase
                .from('registrations')
                .select('match_date_id')
                .eq('user_id', myId);

            if (regErr) { console.error(regErr); el.tip.textContent = '讀取報名資料失敗'; return; }

            const myDateIds = [...new Set((regis || []).map(r => String(r.match_date_id)))];
            if (myDateIds.length === 0) { el.tip.textContent = '你尚未報名任何日期'; el.result.innerHTML = ''; return; }

            const { data: dates, error: dateErr } = await supabase
                .from('match_dates')
                .select('id, date')
                .in('id', myDateIds);

            if (dateErr) { console.error(dateErr); el.tip.textContent = '日期載入失敗'; return; }

            const mapDateLabel = new Map();
            const mapDateISO = new Map();
            (dates || []).forEach(d => {
                const label = new Date(d.date + 'T00:00:00').toLocaleDateString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short',
                });
                mapDateLabel.set(String(d.id), label);
                mapDateISO.set(String(d.id), String(d.date).slice(0, 10));
            });

            el.tip.textContent = '查詢你的所有已上傳班表中…';
            const { data: rows, error } = await supabase
                .from('matches')
                .select('id, games_id, match_dates_id, locations_id, session, time, teams_id1, teams_id2, home_id, base1_id, base2_id, base3_id, recorder_id, supervisor_id, remark')
                .in('match_dates_id', myDateIds)
                .eq('upload', true)
                .order('match_dates_id', { ascending: true })
                .order('locations_id', { ascending: true })
                .order('time', { ascending: true });

            if (error) { console.error(error); el.tip.textContent = '查詢失敗，請稍後再試'; return; }
            if (!rows || rows.length === 0) { el.tip.textContent = '沒有可顯示的已上傳班表。'; return; }

            const matchIds = rows.map(r => r.id);
            const guestNameByKey = new Map();
            if (matchIds.length) {
                const { data: guests, error: gErr } = await supabase
                    .from('match_guest_assignments')
                    .select('match_id, role, guest_name')
                    .in('match_id', matchIds);
                if (!gErr && guests) {
                    guests.forEach(g => guestNameByKey.set(`${String(g.match_id)}:${g.role}`, g.guest_name || ''));
                } else {
                    console.warn('讀取臨時人員失敗：', gErr);
                }
            }

            const teamIds = new Set(), userIds = new Set(), locIds = new Set(), gameIds = new Set(), supIds = new Set();
            rows.forEach(r => {
                if (r.teams_id1) teamIds.add(r.teams_id1);
                if (r.teams_id2) teamIds.add(r.teams_id2);
                ['home_id', 'base1_id', 'base2_id', 'base3_id', 'recorder_id'].forEach(k => r[k] && userIds.add(r[k]));
                if (r.supervisor_id) supIds.add(r.supervisor_id);
                if (r.locations_id) locIds.add(r.locations_id);
                if (r.games_id) gameIds.add(r.games_id);
            });

            const [tRes, pRes, lRes, gRes, sRes] = await Promise.all([
                teamIds.size ? supabase.from('teams').select('id,name').in('id', Array.from(teamIds)) : Promise.resolve({ data: [] }),
                userIds.size ? supabase.from('profiles').select('id,name').in('id', Array.from(userIds)) : Promise.resolve({ data: [] }),
                locIds.size ? supabase.from('locations').select('id,name,url').in('id', Array.from(locIds)) : Promise.resolve({ data: [] }),
                gameIds.size ? supabase.from('games').select('id,name').in('id', Array.from(gameIds)) : Promise.resolve({ data: [] }),
                supIds.size ? supabase.from('supervisor').select('id,name').in('id', Array.from(supIds)) : Promise.resolve({ data: [] }),
            ]);

            const mapTeam = new Map((tRes.data || []).map(t => [String(t.id), t.name]));
            const mapUser = new Map((pRes.data || []).map(p => [String(p.id), p.name]));
            const mapLoc = new Map((lRes.data || []).map(l => [String(l.id), l.name]));
            const mapLocUrl = new Map((lRes.data || []).map(l => [String(l.id), l.url || '']));
            const mapSup = new Map((sRes.data || []).map(s => [String(s.id), s.name]));
            const mapGame = new Map((gRes.data || []).map(g => [String(g.id), g.name]));

            const hasMe = r => [r.home_id, r.base1_id, r.base2_id, r.base3_id, r.recorder_id, r.supervisor_id]
                .map(x => String(x || '')).includes(myId);

            const nameFor = (row, role) => {
                const id = row[role];
                if (id) return mapUser.get(String(id)) || '';
                const g = guestNameByKey.get(`${String(row.id)}:${role}`);
                return g || '';
            };

            const byDate = new Map();
            rows.forEach(r => {
                const did = String(r.match_dates_id || '');
                if (!byDate.has(did)) byDate.set(did, []);
                byDate.get(did).push(r);
            });

            const sortedDateIds = Array.from(byDate.keys()).sort((a, b) => {
                const ia = mapDateISO.get(a) || '9999-12-31';
                const ib = mapDateISO.get(b) || '9999-12-31';
                return ia.localeCompare(ib);
            });

            let anyOutput = false;
            let html = '';

            for (const did of sortedDateIds) {
                const dateRows = byDate.get(did) || [];
                const rowsByLoc = new Map();
                dateRows.forEach(r => {
                    const lid = String(r.locations_id || '');
                    if (!rowsByLoc.has(lid)) rowsByLoc.set(lid, []);
                    rowsByLoc.get(lid).push(r);
                });

                const dateLabel = mapDateLabel.get(did) || did;
                const dateISO = mapDateISO.get(did) || '';

                for (const [lid, list] of rowsByLoc.entries()) {
                    const listHasMe = list.some(hasMe);
                    if (!listHasMe) continue;

                    anyOutput = true;

                    const locName = mapLoc.get(lid) || ('場地ID:' + lid);
                    const locUrl = mapLocUrl.get(lid) || '';
                    const locDisplay = locUrl
                        ? `<a href="${locUrl}" target="_blank" rel="noopener" class="text-blue-900 no-underline hover:underline hover:text-blue-600">${locName}</a>`
                        : locName;

                    const gameNames = [...new Set(list.map(r => mapGame.get(String(r.games_id)) || '').filter(Boolean))];
                    const gameName = gameNames.length === 1 ? gameNames[0] : (gameNames.length > 1 ? gameNames.join('、') : '');

                    const supNames = [...new Set(list.map(r => r.supervisor_id).filter(Boolean).map(id => mapSup.get(String(id)) || ''))].filter(Boolean);
                    const supervisorLine = supNames.length ? supNames.join('、') : '—';

                    const tbodyHtml = list.map(r => {
                        const t1 = mapTeam.get(String(r.teams_id1)) || r.teams_id1 || '-';
                        const t2 = mapTeam.get(String(r.teams_id2)) || r.teams_id2 || '-';
                        const rowHasMe = hasMe(r);
                        const clsMine = rowHasMe ? 'bg-amber-100 font-semibold text-blue-900' : '';
                        return `
                            <tr class="border-b ${clsMine}">
                                <td class="px-4 py-2 border-2 text-center text-lg">${r.session || '-'}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${(r.time || '').slice(0, 5) || '-'}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${t1}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">VS</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${t2}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${nameFor(r, 'home_id')}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${nameFor(r, 'base1_id')}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${nameFor(r, 'base2_id')}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${nameFor(r, 'base3_id')}</td>
                                <td class="px-4 py-2 border-2 text-center text-lg">${nameFor(r, 'recorder_id')}</td>
                                <td class="px-4 py-2 border-2 text-left text-lg">${r.remark || ''}</td>
                            </tr>
                            `;
                    }).join('');

                    html += `
                        <div class="rounded-xl border border-blue-400 overflow-hidden shadow-md group" data-date-label="${dateLabel}" data-loc-name="${locName}" data-game-name="${gameName}">
                        <div class="bg-blue-100 px-4 py-3 font-bold text-xl text-center text-blue-900">
                            ${dateLabel} ${gameName ? `｜ ${gameName}` : ''} ｜ 地點：${locDisplay}
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-md bg-white text-center my-table">
                            <thead class="bg-blue-200 text-blue-900">
                                <tr>
                                <th class="px-3 py-2 border">場次</th>
                                <th class="px-3 py-2 border">時間</th>
                                <th class="px-3 py-2 border">先攻</th>
                                <th class="px-3 py-2 border"></th>
                                <th class="px-3 py-2 border">後攻</th>
                                <th class="px-3 py-2 border">主審</th>
                                <th class="px-3 py-2 border">一壘審</th>
                                <th class="px-3 py-2 border">二壘審</th>
                                <th class="px-3 py-2 border">三壘審</th>
                                <th class="px-3 py-2 border">紀錄</th>
                                <th class="px-3 py-2 border">備註</th>
                                </tr>
                            </thead>
                            <tbody>${tbodyHtml}</tbody>
                            </table>
                        </div>
                        <div class="px-4 py-4 bg-slate-100 relative">
                            <div class="font-bold text-2xl text-blue-800
                                        md:absolute md:left-1/2 md:transform md:-translate-x-1/2
                                        text-left md:text-center">
                            監場：<span class="my-supervisor-line">${supervisorLine}</span>
                            </div>

                            <div class="flex justify-end">
                            <button
                                class="btn-my-download px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                data-title="${dateLabel}${gameName ? `｜ ${gameName}` : ''}｜ 地點：${locName}"
                                data-filename="${(locName || '').replace(/[\\/:*?"<>|]/g, '_')}-${dateISO}">
                                儲存班表
                            </button>
                            </div>
                        </div>
                        </div>
                    `;
                }
            }

            if (!anyOutput) {
                el.result.innerHTML = '';
                el.tip.textContent = '沒有屬於你的班（或尚未上傳）。';
                return;
            }

            el.result.innerHTML = html;
            el.tip.textContent = '';

            el.result.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-my-download');
                if (!btn) return;

                const container = btn.closest('[data-date-label]') || btn.closest('.rounded-xl');
                const title = btn.getAttribute('data-title') || '班表';
                const filename = btn.getAttribute('data-filename') || '班表';
                const tableEl = container.querySelector('.my-table');
                const supervisorText = container.querySelector('.my-supervisor-line')?.textContent?.trim() || '—';

                downloadMyGroupAsPNG(title, filename, tableEl, supervisorText);
            });

            async function downloadMyGroupAsPNG(titleText, filenameBase, tableEl, supervisorText) {
                if (!tableEl) return alert('找不到可下載的表格');
                if (downloadMyGroupAsPNG.__busy) return;
                downloadMyGroupAsPNG.__busy = true;
                const release = () => { downloadMyGroupAsPNG.__busy = false; };
                const cleanTable = tableEl.cloneNode(true);

                cleanTable.querySelectorAll('tbody tr').forEach((tr, idx) => {
                    const isMineRow = tr.classList.contains('bg-amber-100');
                    if (!isMineRow) { if (idx % 2 === 1) tr.style.background = '#f8fbff'; }
                });

                const panel = document.createElement('div');
                Object.assign(panel.style, {
                    position: 'fixed', left: '-99999px', top: '0', zIndex: '2147483647',
                    display: 'inline-block', width: 'auto', maxWidth: 'none',
                    background: '#ffffff', borderRadius: '12px', boxShadow: '0 10px 30px rgba(0,0,0,0.08)',
                    overflow: 'hidden', fontFamily: 'ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial',
                    textAlign: 'center'
                });

                const header = document.createElement('div');
                header.textContent = (titleText || '班表').replace(/&quot;/g, '"');
                Object.assign(header.style, {
                    padding: '18px 20px', fontSize: '24px', fontWeight: '800',
                    color: '#fff', background: 'linear-gradient(90deg,#2563eb,#1e40af)', lineHeight: '1.4'
                });
                panel.appendChild(header);

                const body = document.createElement('div');
                Object.assign(body.style, { padding: '14px 18px 8px 18px', background: '#fff' });

                cleanTable.className = '';
                cleanTable.style.tableLayout = 'auto';
                cleanTable.style.width = 'auto';
                cleanTable.style.maxWidth = 'none';
                cleanTable.style.borderCollapse = 'collapse';
                cleanTable.style.margin = '0 auto';

                cleanTable.querySelectorAll('tbody tr, thead tr').forEach(tr => {
                    const isMineRow = tr.classList.contains('bg-amber-100');
                    tr.querySelectorAll('th, td').forEach(cell => {
                        const isTH = cell.tagName === 'TH';
                        cell.style.border = '1px solid #cfe0ff';
                        cell.style.padding = '10px 14px';
                        cell.style.fontSize = '18px';
                        cell.style.fontWeight = '700';
                        cell.style.textAlign = 'center';
                        cell.style.verticalAlign = 'middle';
                        cell.style.whiteSpace = 'nowrap';
                        cell.style.color = '#0f172a';
                        cell.style.lineHeight = '1.4';
                        if (isTH) cell.style.background = '#eaf2ff';
                        else if (!isMineRow) { if (!cell.style.background) cell.style.background = ''; }
                    });
                });
                body.appendChild(cleanTable);

                const footer = document.createElement('div');
                footer.textContent = `監場：${supervisorText || '—'}`;
                Object.assign(footer.style, {
                    padding: '12px 6px 16px 6px', fontSize: '18px', fontWeight: '700',
                    color: '#1e3a8a', textAlign: 'center', lineHeight: '1.4'
                });
                body.appendChild(footer);
                panel.appendChild(body);
                document.body.appendChild(panel);

                await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

                try {
                    const canvas = await html2canvas(panel, {
                        backgroundColor: '#ffffff',
                        scale: Math.min(Math.max(window.devicePixelRatio || 2, 2), 3),
                        allowTaint: true, useCORS: true,
                        windowWidth: Math.ceil(panel.getBoundingClientRect().width) + 20,
                        windowHeight: Math.ceil(panel.getBoundingClientRect().height) + 40,
                        logging: false
                    });

                    const dataURL = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = dataURL;
                    const filenameSafe = (filenameBase || '班表').replace(/[\\/:*?"<>|]/g, '_').replace(/\s+/g, '');
                    a.download = `${filenameSafe}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } catch (err) {
                    console.error(err);
                    alert('下載圖片失敗，請再試一次');
                } finally {
                    document.body.removeChild(panel);
                    release();
                }
            }
        })();

    document.getElementById('logout-btn').addEventListener('click', function () {
        localStorage.removeItem('profile');
        window.location.href = 'index.html';
    });
</script>
</html>