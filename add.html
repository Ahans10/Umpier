<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增賽事資料 | 裁判出勤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">裁判出勤系統</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">您好!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>修改密碼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </button>
            </div>
        </div>

        <div class="flex justify-center gap-4 mt-10">
            <button id="btn-manage-games" 
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-trophy"></i>賽事管理
            </button>
            <button id="btn-manage-dates"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-calendar-alt"></i>日期管理
            </button>
            <button id="btn-manage-teams"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-users"></i>隊伍管理
            </button>
            <button id="btn-manage-locations"
                class="flex items-center gap-3 px-5 py-4 rounded-xl bg-yellow-100 border border-yellow-300 text-yellow-900 font-semibold text-lg hover:bg-yellow-200 transition shado">
                <i class="fas fa-map-marker-alt mr-1"></i>地點管理
            </button>
        </div>

        <div id="content-inner"
            class="mt-8 max-w-3xl mx-auto bg-white/90 border border-blue-300 rounded-2xl shadow p-8 text-blue-900 flex flex-col gap-6">

            <div id="content-area"></div>

            <div class="flex justify-center" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>返回首頁
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                裁判出勤系統
            </small>
        </div>
    </div>
</body>
<script>
    const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

    const profileStr = localStorage.getItem('profile');
    if (profileStr) {
        const profile = JSON.parse(profileStr);
        const roleText = profile.role === 'admin' ? '管理員'
            : profile.role === 'member' ? '裁判員' : '（未知身份）';

        document.getElementById('welcome-title').innerText = `${profile.name || ''} 您好 !`;
        document.getElementById('profile-info').innerHTML = `
            <div>${roleText}</div>
        `;
    }

    const contentArea = document.getElementById('content-area');

    document.getElementById('btn-manage-games').addEventListener('click', async () => {
        contentArea.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center">賽事管理</h2>
            <form id="game-form" class="flex gap-3 items-end">
            <div class="flex-1">
                <label class="block font-semibold mb-2">賽事名稱</label>
                <input id="game-name" type="text" placeholder="輸入賽事名稱"
                    class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
            </div>
            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">新增賽事</button>
            </form>
            <div id="games-list" class="pt-4"></div>`;

        const gameForm = document.getElementById('game-form');
        const gameNameInput = document.getElementById('game-name');
        const gamesList = document.getElementById('games-list');

        async function renderGamesList() {
            const { data, error } = await supabase.from('games').select('id, name').order('name', { ascending: true });
            if (error) { gamesList.innerHTML = `<p class="text-red-500">載入賽事失敗</p>`; return; }
            if (!data || data.length === 0) { gamesList.innerHTML = `<p class="text-gray-600">目前尚無賽事。</p>`; return; }

            gamesList.innerHTML = `
                <table class="w-full border border-blue-300 text-sm text-left">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                    <th class="border px-4 py-2">賽事名稱</th>
                    <th class="border px-4 py-2 w-32 text-center">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    ${data.map(g => `
                    <tr>
                        <td class="border px-4 py-2">${g.name}</td>
                        <td class="border px-4 py-2 text-center">
                        <div class="inline-flex items-center gap-2">
                            <button data-id="${g.id}" data-name="${g.name}" class="btn-edit-game w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200" title="修改"><i class="fas fa-edit"></i></button>
                            <button data-id="${g.id}" data-name="${g.name}" class="btn-del-game w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200" title="刪除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        </td>
                    </tr>`).join('')}
                </tbody>
                </table>`;

            gamesList.querySelectorAll('.btn-edit-game').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const oldName = btn.getAttribute('data-name') || '';
                    const raw = prompt('請輸入新的賽事名稱：', oldName);
                    if (raw === null) return;
                    const newName = raw.trim();
                    if (!newName) return alert('賽事名稱不可空白');
                    if (newName === oldName) return;
                    const { error } = await supabase.from('games').update({ name: newName }).eq('id', id);
                    if (error) alert('更新失敗');
                    else { await renderGamesList(); alert('更新成功'); }
                });
            });

            gamesList.querySelectorAll('.btn-del-game').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const name = btn.getAttribute('data-name') || '';
                    if (!confirm(`確定要刪除賽事「${name}」？此操作無法復原。`)) return;
                    const { error } = await supabase.from('games').delete().eq('id', id);
                    if (error) alert('刪除失敗');
                    else renderGamesList();
                });
            });
        }

        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = gameNameInput.value.trim();
            if (!name) return alert('請輸入賽事名稱');
            const { error } = await supabase.from('games').insert({ name });
            if (error) alert('新增失敗');
            else { gameNameInput.value = ''; await renderGamesList(); }
        });

        renderGamesList();
    });

    document.getElementById('btn-manage-dates').addEventListener('click', async () => {
        contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-center">比賽日期管理</h2>
            <form id="date-form" class="flex gap-3 items-end">
            <div>
                <label class="block font-semibold mb-2">日期</label>
                <input id="match-date" type="date"
                    class="px-4 py-2 border rounded-lg bg-white text-blue-900" />
            </div>
            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">新增日期</button>
            </form>
            <div id="dates-list" class="pt-4"></div>`;

        const dateForm = document.getElementById('date-form');
        const dateInput = document.getElementById('match-date');
        const datesList = document.getElementById('dates-list');

        async function renderDatesList() {
            const { data, error } = await supabase.from('match_dates').select('id, date').order('date', { ascending: true });
            if (error) { datesList.innerHTML = `<p class="text-red-500">載入日期失敗</p>`; return; }
            if (!data || data.length === 0) { datesList.innerHTML = `<p class="text-gray-600">目前尚無比賽日期。</p>`; return; }

            datesList.innerHTML = `
                <table class="w-full border border-blue-300 text-sm text-left">
                    <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border px-4 py-2">日期</th>
                        <th class="border px-4 py-2 w-32 text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white">
                    ${data.map(d => {
                            const dstr = new Date(d.date).toLocaleDateString('zh-TW', {
                                year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short'
                            });
                            return `
                        <tr>
                            <td class="border px-4 py-2">${dstr}</td>
                            <td class="border px-4 py-2 text-center">
                            <div class="inline-flex items-center gap-2">
                                <button data-id="${d.id}" data-date="${d.date}" class="btn-edit-date w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200" title="修改"><i class="fas fa-edit"></i></button>
                                <button data-id="${d.id}" data-date="${d.date}" class="btn-del-date w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200" title="刪除"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            </td>
                        </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;

            datesList.querySelectorAll('.btn-edit-date').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const oldDate = btn.getAttribute('data-date') || '';
                    const raw = prompt('請輸入新的日期（格式：YYYY-MM-DD）：', oldDate.slice(0, 10));
                    if (raw === null) return;
                    const newDate = raw.trim();
                    if (!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(newDate)) return alert('格式錯誤，請使用 YYYY-MM-DD');
                    const { error } = await supabase.from('match_dates').update({ date: newDate }).eq('id', id);
                    if (error) alert('更新失敗');
                    else { alert('更新成功'); renderDatesList(); }
                });
            });

            datesList.querySelectorAll('.btn-del-date').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const label = btn.getAttribute('data-label') || btn.getAttribute('data-date') || '';
                    if (!confirm(`確定要刪除日期「${label}」的所有賽程？此操作無法復原。`)) return;
                    const { error: delErr } = await supabase.from('matches').delete().eq('match_dates_id', id);
                    if (delErr) {
                        console.error(delErr);
                        alert('刪除賽事失敗，請稍後再試');
                    }
                    const { error } = await supabase.from('match_dates').delete().eq('id', id);
                    if (error) alert('刪除日期失敗');
                    else renderDatesList();
                });
            });
        }

        dateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dateVal = dateInput.value;
            if (!dateVal) return alert('請選擇日期');
            const { error } = await supabase.from('match_dates').insert({ date: dateVal });
            if (error) alert('新增失敗');
            else { dateInput.value = ''; renderDatesList(); alert('新增成功'); }
        });

        renderDatesList();
    });
        
    document.getElementById('btn-manage-teams').addEventListener('click', async () => {
            contentArea.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-center">新增賽事隊伍</h2>

                <div class="space-y-6">
                <div>
                    <label class="block font-semibold mb-2">選擇賽事</label>
                    <select id="games-select" class="w-full border border-blue-300 rounded-lg px-4 py-2 bg-white text-blue-900">
                    <option value="">載入中...</option>
                    </select>
                </div>

                <form id="team-form" class="space-y-4">
                    <div>
                    <label class="block font-semibold mb-2">隊伍名稱</label>
                    <input id="team-name" type="text" placeholder="請輸入隊伍名稱"
                            class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
                    </div>

                    <div class="text-right">
                    <button type="submit"
                            class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        送出新增
                    </button>
                    </div>
                </form>

                <div id="teams-list" class="pt-4 border-t border-blue-200"></div>
                </div>
            `;

            const gamesSelect = document.getElementById('games-select');
            const teamForm = document.getElementById('team-form');
            const teamNameInput = document.getElementById('team-name');
            const teamsList = document.getElementById('teams-list');

            const { data: games, error: gamesErr } = await supabase
                .from('games')
                .select('*')
                .order('name', { ascending: true });

            if (gamesErr) {
                gamesSelect.innerHTML = `<option value="">載入賽事失敗</option>`;
                console.error(gamesErr);
            } else {
                gamesSelect.innerHTML = `<option value="">請選擇賽事</option>` +
                    games.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            }

            gamesSelect.addEventListener('change', () => {
                renderTeamsList(gamesSelect.value);
            });

            teamForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const gamesId = gamesSelect.value;
                const name = (teamNameInput.value || '').trim();

                if (!gamesId) {
                    alert('請先選擇賽事');
                    return;
                }
                if (!name) {
                    alert('請輸入隊伍名稱');
                    return;
                }

                const { data: dup, error: dupErr } = await supabase
                    .from('teams')
                    .select('id')
                    .eq('games_id', gamesId)
                    .ilike('name', name);

                if (!dupErr && dup && dup.length > 0) {
                    alert('此賽事已存在相同隊名，請確認。');
                    return;
                }

                const { error: insertErr } = await supabase.from('teams').insert({
                    games_id: gamesId,
                    name: name
                });

                if (insertErr) {
                    alert('新增失敗，請稍後再試');
                    console.error(insertErr);
                } else {
                    alert('新增成功');
                    teamNameInput.value = '';
                    renderTeamsList(gamesId);
                }
            });

            async function renderTeamsList(gamesId) {
                if (!gamesId) {
                    teamsList.innerHTML = '';
                    return;
                }
                const { data, error } = await supabase
                    .from('teams')
                    .select('id, name')
                    .eq('games_id', gamesId)
                    .order('name', { ascending: true });

                if (error) {
                    teamsList.innerHTML = `<p class="text-red-500">載入隊伍失敗</p>`;
                    console.error(error);
                    return;
                }

                if (!data || data.length === 0) {
                    teamsList.innerHTML = `<p class="text-gray-600">目前此賽事尚無參賽隊伍。</p>`;
                    return;
                }

                teamsList.innerHTML = `
                    <h3 class="text-lg font-bold mb-3">已報名隊伍</h3>
                    <table class="w-full border border-blue-300 text-sm text-left">
                    <thead class="bg-blue-100 text-blue-800">
                        <tr>
                        <th class="border px-4 py-2">隊伍名稱</th>
                        <th class="border px-4 py-2 w-32 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${data.map(t => `
                        <tr>
                            <td class="border px-4 py-2">${t.name}</td>
                            <td class="border px-4 py-2 text-center">
                            <div class="inline-flex items-center gap-2">
                                <button data-id="${t.id}" data-name="${t.name}"
                                        class="btn-edit-team inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"
                                        title="修改">
                                <i class="fas fa-edit"></i>
                                </button>
                                <button data-id="${t.id}" data-name="${t.name}"
                                        class="btn-del-team inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200"
                                        title="刪除">
                                <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                    </table>
                `;

                document.querySelectorAll('.btn-del-team').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const name = btn.getAttribute('data-name') || '';
                        if (!confirm(`確定刪除隊伍「${name}」？此操作無法復原。`)) return;
                        const { error: delErr } = await supabase.from('teams').delete().eq('id', id);
                        if (delErr) {
                            alert('刪除失敗，請稍後再試');
                            console.error(delErr);
                        } else {
                            renderTeamsList(gamesId);
                        }
                    });
                });

                document.querySelectorAll('.btn-edit-team').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const oldName = btn.getAttribute('data-name') || '';
                        const newNameRaw = prompt('請輸入新的隊伍名稱：', oldName);
                        const newName = (newNameRaw || '').trim();

                        if (newName === null) return;
                        if (!newName) {
                            alert('隊伍名稱不可為空白');
                            return;
                        }
                        if (newName === oldName) return;

                        const { data: dup, error: dupErr } = await supabase
                            .from('teams')
                            .select('id')
                            .eq('games_id', gamesId)
                            .ilike('name', newName);

                        if (!dupErr && dup && dup.length > 0) {
                            alert('此賽事已存在相同隊名，請確認。');
                            return;
                        }

                        const { error: updErr } = await supabase
                            .from('teams')
                            .update({ name: newName })
                            .eq('id', id);

                        if (updErr) {
                            alert('更新失敗，請稍後再試');
                            console.error(updErr);
                        } else {
                            alert('更新成功');
                            renderTeamsList(gamesId);
                        }
                    });
                });
            }
        });

    document.getElementById('btn-manage-locations').addEventListener('click', async () => {
        contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-center">比賽地點管理</h2>
            <form id="loc-form" class="flex gap-3 items-end">
            <div class="flex-1">
                <label class="block font-semibold mb-2">地點名稱</label>
                <input id="loc-name" type="text" placeholder="輸入地點名稱"
                    class="w-full px-4 py-2 border rounded-lg bg-white text-blue-900" />
            </div>
            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">新增地點</button>
            </form>
            <div id="loc-list" class="pt-4"></div>`;

            const locForm = document.getElementById('loc-form');
            const locNameInput = document.getElementById('loc-name');
            const locList = document.getElementById('loc-list');

            async function renderLocationsList() {
                const { data, error } = await supabase.from('locations').select('id, name').order('name', { ascending: true });
                if (error) { locList.innerHTML = `<p class="text-red-500">載入地點失敗</p>`; console.error(error); return; }
                if (!data || data.length === 0) { locList.innerHTML = `<p class="text-gray-600">目前尚無地點。</p>`; return; }

                locList.innerHTML = `
                    <table class="w-full border border-blue-300 text-sm text-left">
                        <thead class="bg-blue-100 text-blue-800">
                        <tr>
                            <th class="border px-4 py-2">地點名稱</th>
                            <th class="border px-4 py-2 w-32 text-center">操作</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white">
                        ${data.map(l => `
                            <tr>
                            <td class="border px-4 py-2">${l.name}</td>
                            <td class="border px-4 py-2 text-center">
                                <div class="inline-flex items-center gap-2">
                                <button data-id="${l.id}" data-name="${l.name}" class="btn-edit-loc w-8 h-8 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200" title="修改"><i class="fas fa-edit"></i></button>
                                <button data-id="${l.id}" data-name="${l.name}" class="btn-del-loc w-8 h-8 rounded-full bg-red-100 text-red-700 hover:bg-red-200" title="刪除"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;

                locList.querySelectorAll('.btn-edit-loc').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const oldName = btn.getAttribute('data-name') || '';
                        const raw = prompt('請輸入新的地點名稱：', oldName);
                        if (raw === null) return;
                        const newName = raw.trim();
                        if (!newName) return alert('地點名稱不可空白');
                        if (newName === oldName) return;
                        const { error } = await supabase.from('locations').update({ name: newName }).eq('id', id);
                        if (error) { alert('更新失敗'); console.error(error); }
                        else { alert('更新成功'); renderLocationsList(); }
                    });
                });

                locList.querySelectorAll('.btn-del-loc').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const name = btn.getAttribute('data-name') || '';
                        if (!confirm(`確定刪除地點「${name}」？此操作無法復原。`)) return;
                        const { error } = await supabase.from('locations').delete().eq('id', id);
                        if (error) { alert('刪除失敗'); console.error(error); }
                        else { renderLocationsList(); }
                    });
                });
            }

            locForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = locNameInput.value.trim();
                if (!name) return alert('請輸入地點名稱');

                const { data: dup, error: dupErr } = await supabase.from('locations').select('id').ilike('name', name);
                if (!dupErr && dup && dup.length > 0) return alert('已有相同地點名稱');

                const { error } = await supabase.from('locations').insert({ name });
                if (error) { alert('新增失敗'); console.error(error); }
                else {
                    locNameInput.value = '';
                    renderLocationsList();
                    alert('新增成功');
                }
            });

            renderLocationsList();
        });

    document.getElementById('logout-btn').addEventListener('click', function () {
        localStorage.removeItem('profile');
        window.location.href = 'index.html';
    });

    document.getElementById('btn-manage-games').click();
</script>

</html>