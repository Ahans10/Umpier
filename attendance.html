<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出勤報名 / 修改 | 裁判出勤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">裁判出勤系統</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">您好!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>修改密碼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </button>
            </div>
        </div>

        <div
            class="bg-white/90 border-2 border-blue-400/40 backdrop-blur-md rounded-2xl shadow-2xl p-12 w-full max-w-3xl mx-auto">
            <form id="register-form" class="space-y-6">
                <h2 class="text-2xl font-bold text-center mb-6">選擇欲報名的日期</h2>
                <div class="flex items-center justify-center gap-3 mb-4">
                    <label for="month-select" class="text-2xl font-semibold text-blue-800">選擇月份</label>
                    <select id="month-select"
                        class="border border-blue-400 rounded-lg px-4 py-2 bg-white text-blue-900 text-base shadow-sm">
                        <option value="">載入中...</option>
                    </select>
                </div>
                <div id="date-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-blue-800 text-lg"></div>
                <div class="text-center mt-6">
                    <button type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition">
                        送出報名
                    </button>
                </div>
            </form>

            <div class="flex justify-center mt-4" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>返回首頁
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                裁判出勤系統
            </small>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
        const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : window.Supabase.createClient(supabaseUrl, supabaseKey);

        const profileStr = localStorage.getItem('profile');
        if (profileStr) {
            const profile = JSON.parse(profileStr);
            const roleText = profile.role === 'admin' ? '管理員' : profile.role === 'member' ? '裁判員' : '（未知身份）';
            document.getElementById('welcome-title').innerText = `${profile.name || ''} 您好 !`;
            document.getElementById('profile-info').innerHTML = `<div>${roleText}</div>`;
        }

        let __ALL_DATES = [];
        let __REGISTERED = [];
        let __NOTE_MAP = {};
        let __CURRENT_MONTH_KEY = "";
        let __CURRENT_MONTH_DATE_IDS = [];
        let __IS_ADMIN = false;

        async function loadMatchDates(keepMonthKey) {
            const profileStr = localStorage.getItem('profile');
            if (!profileStr) { alert('尚未登入'); return; }
            const profile = JSON.parse(profileStr);
            const userId = profile.id;
            __IS_ADMIN = (profile.role === 'admin');

            const { data: registered, error: regError } = await supabase
                .from('registrations')
                .select('match_date_id, description')
                .eq('user_id', userId);
            if (regError) { console.error('❌ 載入報名資料失敗：', regError); return; }

            __REGISTERED = registered || [];
            __NOTE_MAP = {};
            __REGISTERED.forEach(r => { __NOTE_MAP[r.match_date_id] = r.description || ''; });

            let q = supabase
                .from('match_dates')
                .select('id, date, is_public')
                .order('date');
            if (!__IS_ADMIN) {
                q = q.eq('is_public', true);
            }
            const { data, error } = await q;
            if (error) { console.error('❌ 載入比賽日期失敗：', error); return; }

            __ALL_DATES = data || [];

            const monthKeys = Array.from(new Set(
                __ALL_DATES.map(d => String(d.date).slice(0, 7))
            )).sort();

            const monthSel = document.getElementById('month-select');
            if (monthKeys.length === 0) {
                monthSel.innerHTML = `<option value="">無可選月份</option>`;
                document.getElementById('date-options').innerHTML =
                    '<div class="text-center text-red-500 col-span-2">目前沒有可報名的比賽日期</div>';
                return;
            }

            const nowYM = new Date().toISOString().slice(0, 7);
            const defaultYM = monthKeys.includes(nowYM) ? nowYM : monthKeys[0];

            __CURRENT_MONTH_KEY = (keepMonthKey && monthKeys.includes(keepMonthKey))
                ? keepMonthKey
                : defaultYM;

            monthSel.innerHTML = monthKeys.map(ym => `<option value="${ym}">${ym}</option>`).join('');
            monthSel.value = __CURRENT_MONTH_KEY;

            renderMonth(__CURRENT_MONTH_KEY);

            monthSel.onchange = () => {
                __CURRENT_MONTH_KEY = monthSel.value;
                renderMonth(__CURRENT_MONTH_KEY);
            };
        }

        function renderMonth(ym) {
            const container = document.getElementById('date-options');
            const registeredIds = new Set(__REGISTERED.map(r => String(r.match_date_id)));

            const filtered = __ALL_DATES.filter(d => String(d.date).slice(0, 7) === ym);
            __CURRENT_MONTH_DATE_IDS = filtered.map(d => d.id);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-blue-800 col-span-2">這個月份沒有可報名的比賽日期</div>`;
                return;
            }

            container.innerHTML = filtered.map(d => {
                const dateText = new Date(d.date).toLocaleDateString('zh-TW', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
                });
                const isChecked = registeredIds.has(String(d.id)) ? 'checked' : '';
                const note = __NOTE_MAP[d.id] || '';

                const privateBadge = (__IS_ADMIN && d.is_public === false)
                    ? `<span class="ml-2 inline-flex items-center rounded-md bg-red-100 text-red-700 text-xs font-semibold px-2 py-0.5">
                        <i class="fa-solid fa-lock mr-1"></i> 不公開
                        </span>`
                    : '';

                return `
        <div class="flex flex-col gap-2 p-4 bg-blue-50 rounded-xl shadow-sm hover:bg-blue-100 transition">
            <label class="flex items-center space-x-4 cursor-pointer">
            <input type="checkbox" name="dates" value="${d.id}" ${isChecked}
                class="accent-blue-600 w-6 h-6 shrink-0" />
            <span class="text-xl sm:text-2xl font-semibold">
                ${dateText}${privateBadge}
            </span>
            </label>
            <input type="text" name="note-${d.id}" placeholder="備註（可不填）"
            value="${note.replace(/"/g, '&quot;')}"
            class="w-full px-3 py-2 rounded-md border border-blue-300 text-base text-blue-800 bg-white" />
        </div>`;
            }).join('');
        }

        document.getElementById('register-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const keepYM = __CURRENT_MONTH_KEY;

            const checkboxes = document.querySelectorAll('input[name="dates"]:checked');
            const selectedDateIds = Array.from(checkboxes).map(cb => cb.value);

            const profileStr = localStorage.getItem('profile');
            if (!profileStr) { alert('尚未登入'); return; }
            const profile = JSON.parse(profileStr);
            const userId = profile.id;

            if (__CURRENT_MONTH_DATE_IDS.length > 0) {
                const { error: deleteError } = await supabase
                    .from('registrations')
                    .delete()
                    .eq('user_id', userId)
                    .in('match_date_id', __CURRENT_MONTH_DATE_IDS);
                if (deleteError) {
                    console.error('❌ 刪除舊報名失敗', deleteError);
                    alert('更新失敗（刪除舊資料失敗）');
                    return;
                }
            }

            const insertData = selectedDateIds.map(id => {
                const noteInput = document.querySelector(`input[name="note-${id}"]`);
                const note = noteInput ? noteInput.value.trim() : '';
                return {
                    user_id: userId,
                    match_date_id: id,
                    description: note,
                    registred_at: new Date().toISOString()
                };
            });

            if (insertData.length > 0) {
                const { error: insertError } = await supabase.from('registrations').insert(insertData);
                if (insertError) {
                    console.error('❌ 報名失敗', insertError);
                    alert('報名失敗，請稍後再試');
                    return;
                }
            }

            alert('已更新本月份的報名！');
            const us = document.getElementById('user-select');
            if (us) us.dispatchEvent(new Event('change'));

            await loadMatchDates(keepYM);
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadMatchDates();
        });

        document.getElementById('logout-btn').addEventListener('click', function () {
            localStorage.removeItem('profile');
            window.location.href = 'index.html';
        });
    </script>
</body>

</html>