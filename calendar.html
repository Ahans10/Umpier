<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œäº‹æ›† | è£åˆ¤å‡ºå‹¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/rrule@2.7.1/dist/es5/rrule.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.8/index.global.min.js"></script>
</head>

<body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 via-blue-200 via-30% to-blue-400 font-sans text-blue-900 font-[Segoe_UI]">
    <div class="container mx-auto py-10 px-4">

        <div class="rounded-2xl bg-white/90 backdrop-blur border border-blue-300 shadow-lg text-center py-8 mb-10">
            <h1 class="text-4xl font-bold mb-3">è£åˆ¤å‡ºå‹¤ç³»çµ±</h1>
        </div>

        <div
            class="max-w-2xl mx-auto bg-white/90 backdrop-blur-md border border-blue-200 rounded-2xl shadow-lg p-8 mb-10 flex flex-col sm:flex-row justify-between items-center gap-6 sm:gap-4">
            <div class="flex w-full sm:w-1/4 justify-center sm:justify-end pr-0 sm:pr-6">
                <i class="fas fa-user text-blue-500 text-6xl drop-shadow-sm"></i>
            </div>

            <div
                class="flex flex-col justify-center sm:items-start items-center sm:w-2/4 text-blue-900 text-center sm:text-left">
                <div id="profile-info" class="text-xl font-bold leading-snug text-blue-800"></div>
                <h2 id="welcome-title" class="text-2xl sm:text-3xl font-bold mb-1">æ‚¨å¥½!</h2>
            </div>

            <div class="flex flex-col sm:w-1/4 w-full items-center gap-3">
                <a href="change_password.html" id="change-pwd-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-blue-400 text-blue-800 font-semibold hover:bg-blue-100 transition shadow-sm text-center">
                    <i class="fas fa-key me-2"></i>ä¿®æ”¹å¯†ç¢¼
                </a>
                <button id="logout-btn"
                    class="w-full px-5 py-2 rounded-xl bg-white border-2 border-red-300 text-red-600 font-semibold hover:bg-red-100 transition shadow-sm text-center">
                    <i class="fas fa-sign-out-alt me-2"></i>ç™»å‡º
                </button>
            </div>
        </div>

        <div
            class="bg-white/90 border-2 border-blue-400/40 backdrop-blur-md rounded-2xl shadow-2xl p-12 w-full max-w-5xl mx-auto">

            <!-- ç®¡ç†å“¡æ‰é¡¯ç¤ºæ–°å¢é¢æ¿ -->
            <div id="add-panel" class="mt-10 max-w-4xl mx-auto hidden">
                <div class="rounded-3xl border border-blue-300 bg-white/90 backdrop-blur p-8 shadow-xl">
            
                    <!-- æ¨™é¡Œåˆ— -->
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-2xl bg-blue-600 text-white flex items-center justify-center shadow">
                                <i class="fa-solid fa-calendar-plus text-xl"></i>
                            </div>
                            <div>
                                <div class="text-2xl font-extrabold text-blue-900">æ–°å¢è¡Œäº‹æ›†äº‹ä»¶</div>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="mode-game-btn"
                                class="px-5 py-2.5 rounded-xl border-2 border-blue-600 bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-sm">
                                ä¾è³½äº‹
                            </button>
                            <button id="mode-date-btn"
                                class="px-5 py-2.5 rounded-xl border-2 border-blue-600 text-blue-900 font-bold hover:bg-blue-50 transition">
                                é¸æ—¥æœŸ
                            </button>
                        </div>
                    </div>
            
                    <!-- æ–¹å¼ 1ï¼šä¾è³½äº‹ -->
                    <div id="mode-game" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-base sm:text-lg font-extrabold text-blue-900 mb-3">é¸æ“‡è³½äº‹</label>
                                <select id="games-select"
                                    class="w-full rounded-xl border-2 border-blue-200 px-4 py-3 text-blue-900 font-medium focus:outline-none focus:border-blue-500 bg-white">
                                </select>
                            </div>
            
                            <div>
                                <label class="block text-base sm:text-lg font-extrabold text-blue-900 mb-3">é¡¯ç¤ºæ–‡å­—ï¼ˆä¸é¡¯ç¤ºè³½äº‹åç¨±ï¼‰</label>
                                <input id="game-text" type="text" placeholder="ä¾‹å¦‚ï¼šå°±æ˜¯æ£’ / æœ‰æ¯”è³½ / éœ€å ±åˆ°"
                                    class="w-full rounded-xl border-2 border-blue-200 px-4 py-3 text-blue-900 font-medium focus:outline-none focus:border-blue-500 bg-white" />
                            </div>
                        </div>

                        <div class="mt-6 flex items-start gap-3 rounded-xl bg-blue-50 border border-blue-200 px-5 py-4">
                            <i class="fa-solid fa-circle-info text-blue-600 mt-1"></i>
                            <div class="text-sm sm:text-base text-blue-900 leading-relaxed font-medium">
                                ç³»çµ±æœƒè‡ªå‹•æ ¹æ“šè©²è³½äº‹çš„ <b>è³½ç¨‹æ—¥æœŸ</b>ï¼Œ
                                åœ¨è¡Œäº‹æ›†ä¸Šé¡¯ç¤ºä½ è¨­å®šçš„æ–‡å­—ã€‚
                            </div>
                        </div>
            
                        <div class="mt-6 flex justify-end">
                            <button id="save-game-entry"
                                class="px-6 py-3 rounded-xl bg-blue-600 text-white text-lg font-bold hover:bg-blue-700 transition shadow">
                                <i class="fa-solid fa-plus mr-2"></i>æ–°å¢äº‹ä»¶
                            </button>
                        </div>
                    </div>
            
                    <!-- æ–¹å¼ 2ï¼šé¸æ—¥æœŸ -->
                    <div id="mode-date" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-base sm:text-lg font-extrabold text-blue-900 mb-3">å·²é¸æ—¥æœŸå€é–“</label>
                                <input id="picked-range" type="text" readonly
                                    class="w-full rounded-xl border-2 border-blue-200 px-4 py-3 bg-blue-50 text-blue-900 font-semibold" />
                                <div class="mt-3 text-base sm:text-lg text-blue-800 font-semibold">
                                    ğŸ‘‰ åœ¨è¡Œäº‹æ›†ä¸Š <span class="font-bold">æ‹–æ›³é¸å–</span> æˆ– <span class="font-bold">é»æ“Š</span> æ—¥æœŸå³å¯
                                </div>
                            </div>
            
                            <div>
                                <label class="block text-base sm:text-lg font-extrabold text-blue-900 mb-3">é¡¯ç¤ºæ–‡å­—</label>
                                <input id="date-text" type="text" placeholder="ä¾‹å¦‚ï¼šæœ‰æ¯”è³½"
                                    class="w-full rounded-xl border-2 border-blue-200 px-4 py-3 text-blue-900 font-medium focus:outline-none focus:border-blue-500 bg-white" />
                            </div>
                        </div>

                        <div class="mt-6 flex items-start gap-3 rounded-xl bg-blue-50 border border-blue-200 px-5 py-4">
                            <i class="fa-solid fa-lightbulb text-blue-600 mt-1"></i>
                            <div class="text-sm sm:text-base text-blue-900 leading-relaxed font-medium">
                                å¯ä¸€æ¬¡é¸æ“‡ <b>å¤šå¤©æ—¥æœŸ</b>ï¼Œ
                                æ–°å¢å¾Œé»æ“Šè¡Œäº‹æ›†ä¸Šçš„äº‹ä»¶å³å¯ <b>åˆªé™¤</b>ã€‚
                            </div>
                        </div>
            
                        <div class="mt-6 flex justify-between">
                            <button id="clear-picked"
                                class="px-5 py-3 rounded-xl border-2 border-blue-300 text-blue-900 font-semibold hover:bg-blue-50 transition">
                                æ¸…é™¤å·²é¸æ—¥æœŸ
                            </button>
                            <button id="save-date-entry"
                                class="px-6 py-3 rounded-xl bg-blue-600 text-white text-lg font-bold hover:bg-blue-700 transition shadow">
                                <i class="fa-solid fa-plus mr-2"></i>æ–°å¢äº‹ä»¶
                            </button>
                        </div>
                    </div>
            
                </div>
            </div>

            <div id="calendar" class="w-full sm:max-w-4xl mx-auto mt-6 
            text-[12px] sm:text-base 
            [&_.fc-event-title]:whitespace-normal 
            [&_.fc-event-title]:break-words"></div>

            <div class="flex justify-center mt-6" id="back-button">
                <a href="main.html"
                    class="text-center py-2 px-6 rounded-xl border-2 border-blue-600 text-blue-900 font-semibold hover:bg-gradient-to-r hover:from-blue-600 hover:to-blue-500 hover:text-white transition">
                    <i class="fas fa-arrow-left me-2"></i>è¿”å›é¦–é 
                </a>
            </div>
        </div>

        <div class="text-center mt-10">
            <small class="text-blue-800">
                <i class="fas fa-copyright mr-1"></i>
                è£åˆ¤å‡ºå‹¤ç³»çµ±
            </small>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://qfupnebeqjzhqplqkuqz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmdXBuZWJlcWp6aHFwbHFrdXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0OTgzNzksImV4cCI6MjA2NjA3NDM3OX0.NUeJJ9liEi1Ckx9BrCTIr5ibZqkPaxQYLVC7-VvbzvA';
        const supabase = window.supabase
            ? window.supabase.createClient(supabaseUrl, supabaseKey)
            : window.Supabase.createClient(supabaseUrl, supabaseKey);

        function fmtLocalDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
        }

        function addOneDay(dateStr) {
            const d = new Date(dateStr + 'T12:00:00');
            d.setDate(d.getDate() + 1);
            return fmtLocalDate(d);
        }

        const profileStr = localStorage.getItem('profile');
        let profile = null;

        if (!profileStr) {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = 'index.html';
        } else {
            profile = JSON.parse(profileStr);
            const roleText = profile.role === 'admin' ? 'ç®¡ç†å“¡'
                : profile.role === 'member' ? 'è£åˆ¤å“¡' : 'ï¼ˆæœªçŸ¥èº«ä»½ï¼‰';

            document.getElementById('welcome-title').innerText = `${profile.name || ''} æ‚¨å¥½ !`;
            document.getElementById('profile-info').innerHTML = `<div>${roleText}</div>`;
        }

        const addPanel = document.getElementById('add-panel');
        if (profile?.role === 'admin') addPanel.classList.remove('hidden');

        function eventStyle(title, start, endExclusive, entryId, mode) {
            const colorMap = {
                game: '#1E40AF',
                date: '#111827'
            };

            return {
                title,
                start,
                end: endExclusive,
                color: colorMap[mode] || '#111827',
                textColor: '#ffffff',
                classNames: ['font-bold', 'text-sm', 'px-1', 'py-0.5', 'rounded'],
                extendedProps: { entry_id: entryId, mode }
            };
        }

        function compressDatesToRanges(dateList) {
            const dates = [...new Set(dateList)].sort();
            const ranges = [];
            if (dates.length === 0) return ranges;

            let start = dates[0];
            let prev = dates[0];

            const toLocalDate = (s) => new Date(s + 'T12:00:00');

            for (let i = 1; i < dates.length; i++) {
                const cur = dates[i];
                const prevD = toLocalDate(prev);
                prevD.setDate(prevD.getDate() + 1);
                const expected = fmtLocalDate(prevD);

                if (cur === expected) {
                    prev = cur;
                } else {
                    ranges.push({ start, end: prev });
                    start = cur;
                    prev = cur;
                }
            }
            ranges.push({ start, end: prev });
            return ranges;
        }

        async function loadCalendarEvents() {
            const { data: entries, error } = await supabase
                .from('calendar_entries')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                alert('è®€å–è¡Œäº‹æ›†è³‡æ–™å¤±æ•—');
                return [];
            }

            const events = [];

            for (const e of entries.filter(x => x.mode === 'date')) {
                events.push(eventStyle(
                    e.text,
                    e.start_date,
                    addOneDay(e.end_date),
                    e.id,
                    'date'
                ));
            }

            const gameEntries = entries.filter(x => x.mode === 'game' && x.games_id);
            const gameIds = [...new Set(gameEntries.map(x => x.games_id))];

            if (gameIds.length > 0) {
                const { data: rows } = await supabase
                    .from('matches')
                    .select('games_id, match_dates:match_dates_id(date)')
                    .in('games_id', gameIds);

                const map = {};
                for (const r of rows || []) {
                    if (!map[r.games_id]) map[r.games_id] = [];
                    if (r.match_dates?.date) map[r.games_id].push(r.match_dates.date);
                }

                for (const e of gameEntries) {
                    const ranges = compressDatesToRanges(map[e.games_id] || []);
                    for (const rg of ranges) {
                        events.push(eventStyle(
                            e.text,
                            rg.start,
                            addOneDay(rg.end),
                            e.id,
                            'game'
                        ));
                    }
                }
            }
            return events;
        }

        async function loadGamesOptions() {
            const sel = document.getElementById('games-select');
            sel.innerHTML = '';
            const { data } = await supabase.from('games').select('id, name').order('name');
            sel.innerHTML = `<option value="">è«‹é¸æ“‡è³½äº‹</option>` +
                (data || []).map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const calendarEl = document.getElementById('calendar');
            let pickedStart = null;
            let pickedEndExclusive = null;
            let tapStart = null;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                selectMirror: true,
                height: 'auto',

                select(info) {
                    pickedStart = info.startStr;
                    pickedEndExclusive = info.endStr;
                    const end = new Date(info.end);
                    end.setDate(end.getDate() - 1);
                    document.getElementById('picked-range').value =
                        `${pickedStart} ~ ${fmtLocalDate(end)}`;
                },

                dateClick(info) {
                    const d = info.dateStr;

                    if (!tapStart) {
                        tapStart = d;
                        pickedStart = d;
                        pickedEndExclusive = addOneDay(d);
                        document.getElementById('picked-range').value = `${d} ~ ${d}`;
                        return;
                    }

                    const a = new Date(tapStart + 'T12:00:00');
                    const b = new Date(d + 'T12:00:00');
                    const start = a <= b ? tapStart : d;
                    const end = a <= b ? d : tapStart;

                    pickedStart = start;
                    pickedEndExclusive = addOneDay(end);
                    document.getElementById('picked-range').value = `${start} ~ ${end}`;
                    tapStart = null;
                },

                eventClick: async function (info) {
                    if (profile?.role !== 'admin') return;
                    if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${info.event.title}ã€ï¼Ÿ`)) return;

                    await supabase.from('calendar_entries')
                        .delete()
                        .eq('id', info.event.extendedProps.entry_id);

                    calendar.removeAllEventSources();
                    calendar.addEventSource(await loadCalendarEvents());
                },

                locale: 'zh-tw',
                firstDay: 0
            });

            calendar.render();
            calendar.addEventSource(await loadCalendarEvents());

            if (profile?.role === 'admin') {
                document.getElementById('mode-game-btn').onclick = async () => {
                    document.getElementById('mode-game').classList.remove('hidden');
                    document.getElementById('mode-date').classList.add('hidden');
                    await loadGamesOptions();
                };

                document.getElementById('mode-date-btn').onclick = () => {
                    document.getElementById('mode-date').classList.remove('hidden');
                    document.getElementById('mode-game').classList.add('hidden');
                };

                document.getElementById('clear-picked').onclick = () => {
                    pickedStart = pickedEndExclusive = tapStart = null;
                    document.getElementById('picked-range').value = '';
                    calendar.unselect();
                };

                document.getElementById('save-game-entry').addEventListener('click', async () => {
                    try {
                        if (profile?.role !== 'admin') return alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥æ–°å¢äº‹ä»¶');

                        const gamesId = document.getElementById('games-select').value;
                        const text = document.getElementById('game-text').value.trim();

                        if (!gamesId) return alert('è«‹å…ˆé¸æ“‡è³½äº‹');
                        if (!text) return alert('è«‹è¼¸å…¥è¦é¡¯ç¤ºçš„æ–‡å­—');

                        const { error } = await supabase
                            .from('calendar_entries')
                            .insert([{ mode: 'game', games_id: gamesId, text }]);

                        if (error) {
                            console.error(error);
                            return alert('æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰');
                        }

                        calendar.removeAllEventSources();
                        calendar.addEventSource(await loadCalendarEvents());
                        document.getElementById('game-text').value = '';
                        alert('æ–°å¢æˆåŠŸ âœ…');
                    } catch (err) {
                        console.error(err);
                        alert('æ–°å¢å¤±æ•—ï¼ˆJS ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹çœ‹ Consoleï¼‰');
                    }
                });

                document.getElementById('save-date-entry').addEventListener('click', async () => {
                    try {
                        if (profile?.role !== 'admin') return alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥æ–°å¢äº‹ä»¶');

                        const text = document.getElementById('date-text').value.trim();
                        if (!pickedStart || !pickedEndExclusive) return alert('è«‹åœ¨è¡Œäº‹æ›†ä¸Šå…ˆé¸å–æ—¥æœŸï¼ˆå¯å¤šå¤©ï¼‰');
                        if (!text) return alert('è«‹è¼¸å…¥è¦é¡¯ç¤ºçš„æ–‡å­—');

                        const endEx = new Date(pickedEndExclusive + 'T12:00:00');
                        endEx.setDate(endEx.getDate() - 1);
                        const endDate = fmtLocalDate(endEx);

                        const { error } = await supabase
                            .from('calendar_entries')
                            .insert([{ mode: 'date', text, start_date: pickedStart, end_date: endDate }]);

                        if (error) {
                            console.error(error);
                            return alert('æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰');
                        }

                        calendar.removeAllEventSources();
                        calendar.addEventSource(await loadCalendarEvents());

                        document.getElementById('date-text').value = '';
                        pickedStart = null;
                        pickedEndExclusive = null;
                        document.getElementById('picked-range').value = '';
                        calendar.unselect();

                        alert('æ–°å¢æˆåŠŸ âœ…');
                    } catch (err) {
                        console.error(err);
                        alert('æ–°å¢å¤±æ•—ï¼ˆJS ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹çœ‹ Consoleï¼‰');
                    }
                });
            }
        });

        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('profile');
            window.location.href = 'index.html';
        };
    </script>
</body>

</html>